function IptvCompareView(model){var mq_flag=mq(),$container=$("#tv-compare"),$packFilter=$container.find(".package-select"),$packFilterList=$packFilter.find(".package-select__list-wrap"),$packHeadersWrapper=$("#package-label-wrap"),$packHeaders,$subjectRowsWrapper=$container.find(".packages-compare"),$subjectRows,$mobileSubjectRows,$costs=$container.find(".package-list"),$inputSearch=$container.find(".package-search").find(".input-search"),packKeys=[],allPackKeys=[],selection=[],isExitOnConnect=false,filteredChannels=null,$defaultBanner=$container.find(".js-item-desc-default"),$channelBanner=$container.find(".js-item-desc-tvchannel"),$channelHead=$channelBanner.find(".content-head-24"),$channelLogo=$channelBanner.find("img.tvchannel-info__logo"),$channelNumber=$channelBanner.find(".tvchannel-info__btn-no"),$channelLanguage=$channelBanner.find(".tvchannel-info__lang-val"),$channelContent=$channelBanner.find(".content-p-0");var $packs=$(model.packs);$packs.each(function(){var cfgPack=IptvCompareConfig.getPackByKey(this.key);packKeys.push(this.key);allPackKeys.push(this.key);var $checkBox=$("<input>",{"class":"package-select__check checkbox-inline",type:"checkbox",checked:"checked"});$checkBox.data("packKey",this.key);$checkBox.change(onChangePackFilter);var $label=$('<label class="package-select__label">');$label.append($checkBox);$label.append(cfgPack.label);$packFilterList.append($label);var $packHeader=$('<div class="package-label package-label_view-panel" >');$packHeader.data("packKey",this.key);$packHeader.append('<div class="package-label__ico '+cfgPack.logo+'" data-alias="'+cfgPack.alias+'"><div class="package-label__count">'+this.size+"</div></div>").append('<div class="package-label__name">'+cfgPack.label+'<sup class="package-label__count_mq-mobile">'+this.size+"</sup></div>");$packHeader.click(onClickPackHeader);$packHeadersWrapper.append($packHeader)});$packHeaders=$packHeadersWrapper.find(".package-label");var $mobileSubjectRowsWrapper=$('<div class="packages-compare packages-compare_mq-mobile">');$(model.subjects).each(function(){var cfgSubject=IptvCompareConfig.getSubjectByName(this.name),$row=$('<div class="packages-compare__row">'),$unit=$('<div class="units-row">'),$group=$('<div class="channel-group">'),$head=$('<div class="channel-group__head">'),$diagrams=$('<div class="package-diagrams-wrap">');$head.html(cfgSubject.label+'<sup class="channel-group__count"></sup>');$head.click(onClickSubjectHeader);$row.data("subjectKey",this.key);$group.html($head);$unit.append($group).append($diagrams);$row.append($unit);var $mobileRow=$row.clone(true);$packs.each(function(){var $diagram=$('<div class="package-label package-label_view-diagram">');$diagram.data("packKey",this.key);$diagram.html('<div class="package-diagram"></div><div class="package-label__count package-label__count_view-diagram"></div>');$diagrams.append($diagram)});$row.append(createChannelListForSubject(this.key));$subjectRowsWrapper.append($row);$mobileSubjectRowsWrapper.append($mobileRow)});$subjectRows=$subjectRowsWrapper.find(".packages-compare__row:gt(0)");$mobileSubjectRowsWrapper.insertAfter($packHeaders);$mobileSubjectRows=$packHeadersWrapper.find(".packages-compare__row");var subjectRows=[];$subjectRows.each(function(){var $row=$(this),subjectKey=$row.data("subjectKey");subjectRows.push({$row:$row,$mobileRows:$mobileSubjectRows.filter(function(){return $(this).data("subjectKey")==subjectKey})})});$subjectRows=$(subjectRows);delete subjectRows;delete $packs;delete $mobileSubjectRowsWrapper;$packHeaders.each(function(){var $packHeader=$(this),packKey=$packHeader.data("packKey");$packHeader.next(".packages-compare").elem("row").each(function(){var $mobileRow=$(this);$mobileRow.data("packKey",packKey);$mobileRow.append(createChannelListForSubject($mobileRow.data("subjectKey"),packKey))})});for(var i=0,n=model.packs.length;i<n;i++){var cost=IptvCompareConfig.costs[i];$costs.append('<p class="row-brd-dotted package-list__item"><span class="row-brd-dotted__cnt package-list__item-name">'+(i+1)+'-й пакет</span><span class="row-brd-dotted__cnt package-list__item-price"><span class="cost-rubmon">'+cost+"</span></span></span></p>")}function createChannelDiagram(isExists,isMobile){var $label=$('<div class="package-label package-label_view-channel">'),$diagram=$('<div class="package-diagram">');if(isExists){$diagram.setMod("fill","100")}$label.wrapInner($diagram);if(isMobile){$label.setMod("visible").css("width","100%")}return $label}function createChannelListForSubject(subjectKey,packKey){var subject=model.getSubjectByKey(subjectKey),$channelsInPacks=$(subject.channelsInPacks),allChannels=model.getSubjectChannels(subjectKey,packKeys),$subrows=$('<div class="channels-list">');$(allChannels).each(function(){var channel=this,$subrow=$('<div class="channels-list__row units-row">');var $name=$('<div class="channels-list__row-head">');$name.html('<span class="channels-list__channel-name">'+channel.name+"</span>");$name.hover(onOverChannelHeader,onOutChannelHeader);$name.click(onClickChannelHeader);$subrow.append($name);$subrow.data("number",channel.number);var $diagrams=$('<div class="package-diagrams-wrap">');if(packKey){var channels=subject.getChannelsByPackKey(packKey);$diagrams.append(createChannelDiagram($.inArray(channel,channels)!=-1,true))}else{$channelsInPacks.each(function(){$diagrams.append(createChannelDiagram($.inArray(channel,this.channels)!=-1))})}$subrow.append($diagrams);$subrows.append($subrow)});return $subrows}function updatePackWidths(){var width;if(mq_flag===3||mq_flag===4){width="100%"}else{width=100/packKeys.length+"%"}$packHeaders.css("width",width)}function getMeasure(count,measures){var module=count%10;return module==1?measures[0]:(module>=2&&module<=4?measures[1]:measures[2])}var packMeasures=["пакет","пакета","пакетов"],channelMeasures=["канал","канала","каналов"];function refreshCost(){var price=0,selectionSize=0;for(var i in selection){if(selection[i]){price+=IptvCompareConfig.costs[selectionSize];selectionSize++}}$costs.elem("item").delMod("selected").filter(":lt("+selectionSize+")").setMod("selected");$costs.elem("cost-price").html(price);$costs.elem("total-pack").html(selectionSize+" "+getMeasure(selectionSize,packMeasures));var selectionKeys=[];for(var i in packKeys){if(selection[i]){selectionKeys.push(packKeys[i])}}var channelCount=model.getChannelCount(selectionKeys);$costs.elem("total-chan").html(channelCount+" "+getMeasure(channelCount,channelMeasures))}function setDiagram($diagram,currentSize,fullSize){$diagram.find(".package-label__count_view-diagram").html(currentSize);var parts=IptvCompareConfig.parts,$chart=$diagram.find(".package-diagram");$chart.delMod("fill");var part=fullSize!=0?currentSize/fullSize*100:0;roundPart=null;if(part==0){roundPart=0}else{if(part==100){roundPart=parts[parts.length-1]}else{for(var i=0,n=parts.length-1;i<n;i++){if(part<=parts[i]){roundPart=parts[i];break}}roundPart=roundPart||parts[parts.length-2]}}if(roundPart!=0){$chart.setMod("fill",roundPart)}}$packFilter.elem("head").on("click",function(){if($(this).hasMod("active")){$(this).delMod("active");$packFilter.delMod("active")}else{$(this).setMod("active");$packFilter.setMod("active")}});function updateSubjectRowView($row,visibleChannels,width,isReSearch){if(visibleChannels.length>0){$row.find(".channels-list").elem("row").each(function(){var $subrow=$(this),isExists=false,number=$subrow.data("number");for(var i in visibleChannels){if(visibleChannels[i].number==number){isExists=true;break}}if(isExists){$subrow.show();if(width){$subrow.find(".package-label").css("width",width)}}else{$subrow.hide()}});$row.show();if(isReSearch&&$row.hasMod("active")){$row.find(".channels-list").removeAttr("data-max-height").cloneWidthHeight("height")}}else{$row.hide()}}$(window).on("resize",function(){var old_mq_flag=mq_flag;mq_flag=mq();if(mq_flag===1){$container.delMod("overlay");$(".channel-compare-desc").remove()}else{if((mq_flag===3||mq_flag===4)&&(old_mq_flag===1||old_mq_flag===2)){$packHeaders.each(function(){var $packHeader=$(this);if(!$packHeader.hasMod("disabled")&&$packHeader.hasMod("expand")){$packHeader.next().removeAttr("data-max-height").cloneWidthHeight("height")}})}}updatePackWidths()});$(".package-activate").containedStickyScroll();$("#connectInIptvCompare").click(function(){isExitOnConnect=true;$.magnificPopup.instance.close()});$container.find(".link-print-before").click(function(){var subjectNames=[];$subjectRows.each(function(){var $subjectRow=this.$row;if($subjectRow.hasMod("active")){var subject=model.getSubjectByKey($subjectRow.data("subjectKey"));subjectNames.push(subject.name)}});window.open("/forPrint#"+$.param({tag:app.wi.cart.tag_id,packKeys:packKeys.join(";"),subjectNames:subjectNames.join(";")}),"_blank")}).show();var allChannelsOpenLabels=["Раскрыть все","Свернуть все"];$("#all-channels-open").click(function(){var $this=$(this),needToExpand=!$this.hasMod("active");if(needToExpand){$this.setMod("active");$this.text(allChannelsOpenLabels[1])}else{$this.delMod("active");$this.text(allChannelsOpenLabels[0])}$subjectRows.each(function(){this.$row.find(".channel-group__head").trigger("click",[{needToExpand:needToExpand}])})});function onChangePackFilter(){var oldPackKeys=packKeys;packKeys=[];var $checked=$packFilterList.find(".package-select__check:checked");$checked.each(function(){packKeys.push($(this).data("packKey"))});if($checked.size()==1){$checked.attr("disabled",true)}else{$checked.removeAttr("disabled")}updatePackWidths();selection=[];$packHeaders.each(function(){var $packHeader=$(this);if($.inArray($packHeader.data("packKey"),packKeys)!=-1){$packHeader.delMod("disabled");var isSelect=$packHeader.hasMod("active");selection.push(isSelect)}else{$packHeader.setMod("disabled")}});var needShow=[];for(var i in packKeys){var packKey=packKeys[i];if(oldPackKeys.indexOf(packKey)==-1){needShow.push(packKey)}}for(var i in needShow){var packKey=needShow[i],index=allPackKeys.indexOf(packKey);$subjectRows.each(function(){var $row=this.$row;$row.find(".package-label:eq("+index+")").show();$row.find(".channels-list").elem("row").each(function(){$(this).find(".package-label:eq("+index+")").show()})})}var needHide=[];for(var i in oldPackKeys){var packKey=oldPackKeys[i];if(packKeys.indexOf(packKey)==-1){needHide.push(packKey)}}for(var i in needHide){var packKey=needHide[i],index=allPackKeys.indexOf(packKey);$subjectRows.each(function(){var $row=this.$row;$row.find(".package-label:eq("+index+")").hide();$row.find(".channels-list").elem("row").each(function(){$(this).find(".package-label:eq("+index+")").hide()})})}$costs.elem("item").hide().filter(":lt("+packKeys.length+")").show();refreshCost();$subjectRows.each(function(){var $row=this.$row,$mobileRows=this.$mobileRows,subjectKey=$row.data("subjectKey"),size,channels;if(filteredChannels){size=model.getSubjectChannelCount(subjectKey,packKeys);channels=model.getCrossOfSubjectChannels(filteredChannels,subjectKey,packKeys)}else{channels=model.getSubjectChannels(subjectKey,packKeys);size=channels.length}$row.find(".channel-group__count").html(channels.length);var $diagrams=$row.find(".package-diagrams-wrap"),width=100/packKeys.length+"%";$diagrams.find(".package-label_view-diagram").each(function(){var $diagram=$(this),packKey=$diagram.data("packKey");if($.inArray(packKey,packKeys)!=-1){$diagram.delMod("disabled");setDiagram($diagram,model.getSubjectByKey(subjectKey).getChannelsByPackKey(packKey).length,size);$diagram.css("width",width)}else{$diagram.setMod("disabled")}});this.$mobileRows.each(function(){var $mobileRow=$(this),$group=$mobileRow.find(".channel-group");$group.parent().find(".package-diagrams-wrap").html($row.find(".package-label:eq("+i+")").clone().css("width","100%").setMod("visible"));$group.find(".channel-group__count").text($row.find(".channel-group__count").text())});updateSubjectRowView($row,channels,width);$mobileRows.each(function(){updateSubjectRowView($(this),channels)})})}function toogleHighlight($row,absIndex,index){$row.find(".package-diagrams-wrap").find(".package-label_view-diagram:eq("+absIndex+")").toggleClass("package-label_state-first package-label_active-true").find(".package-diagram").toggleClass("package-diagram_active-true");$row.find(".channels-list__row").each(function(){$(this).find(".package-label_view-channel:eq("+index+")").toggleClass("package-label_state-first package-label_active-true").find(".package-diagram").toggleClass("package-diagram_active-true")})}function selectPack($packHeader){var packKey=$packHeader.data("packKey"),index=$.inArray(packKey,packKeys),absIndex=$.inArray(packKey,allPackKeys);selection[index]=!selection[index];refreshCost();$packHeader.toggleClass("package-label_state-first package-label_active-true");$subjectRows.each(function(){toogleHighlight(this.$row,absIndex,index)});$mobileSubjectRows.each(function(){var $mobileRow=$(this);if($mobileRow.data("packKey")==packKey){toogleHighlight($mobileRow,0,0)}})}function openOrClosePack($packHeader){if($packHeader.hasMod("expand")){$packHeader.delMod("expand");$packHeader.next().removeAttr("style").delMod("active")}else{var $mobileSubjectRowsWrapper=$packHeader.next();$packHeader.setMod("expand");$mobileSubjectRowsWrapper.cloneWidthHeight("height").setMod("active")}}function onClickPackHeader(){if(mq_flag===1||mq_flag===2){selectPack($(this))}else{if(mq_flag===3||mq_flag===4){openOrClosePack($(this))}}}function expandRow($row,$subjectHeader,$diagrams){$row.setMod("active");$subjectHeader.setMod("active");$diagrams.setMod("hidden");$row.find(".channels-list").show().cloneWidthHeight("height").setMod("active");if(mq_flag==3||mq_flag==4){$row.closest(".packages-compare").removeAttr("data-max-height").cloneWidthHeight("height")}}function collapseRow($row,$subjectHeader,$diagrams){$row.delMod("active");$subjectHeader.delMod("active");$diagrams.delMod("hidden");$row.find(".channels-list").hide().cloneWidthHeight("height").delMod("active")}function onClickSubjectHeader(e,data){var $subjectHeader=$(this),$row=$subjectHeader.closest(".packages-compare__row"),$diagrams=$row.find(".units-row:eq(0)").find(".package-diagrams-wrap"),needToExpand=(data!=null)?data.needToExpand:null,isExpanded=$row.hasMod("active");if(needToExpand==null){if(isExpanded){collapseRow($row,$subjectHeader,$diagrams)}else{expandRow($row,$subjectHeader,$diagrams)}}else{if(needToExpand){if(!isExpanded){expandRow($row,$subjectHeader,$diagrams)}}else{collapseRow($row,$subjectHeader,$diagrams)}}}function searchChannels(name){name=name.trim();if(name.length>0){filteredChannels=model.getChannelsByNamePart(name)}else{filteredChannels=null}$subjectRows.each(function(){var $row=this.$row,subjectKey=$row.data("subjectKey"),channels=filteredChannels?model.getCrossOfSubjectChannels(filteredChannels,subjectKey,packKeys):model.getSubjectChannels(subjectKey,packKeys);updateSubjectRowView($row,channels,null,true);this.$mobileRows.each(function(){updateSubjectRowView($(this),channels)})})}$inputSearch.on("keydown",function(e){if(e.keyCode==13){searchChannels($inputSearch.val())}});$container.find(".package-search").find(".btn-search").click(function(){searchChannels($inputSearch.val())});function initChannelBanner(number){var channel=model.getChannelByNumber(number);$channelHead.html(channel.name);$channelLogo.attr("src","http://www.rt.ru/data/img/TVlogo/"+channel.number+".png");$channelNumber.html(channel.number);$channelLanguage.html(channel.language);$channelContent.html(channel.description)}function onOverChannelHeader(){if(mq_flag!=1){return false}initChannelBanner($(this).parent().data("number"));$defaultBanner.removeClass("is-active");$channelBanner.addClass("is-active")}function onOutChannelHeader(){if(mq_flag!=1){return false}$defaultBanner.addClass("is-active");$channelBanner.removeClass("is-active")}function onClickChannelHeader(){if(mq_flag===1){return false}var $this=$(this),$channels_list=$this.closest(".channels-list");initChannelBanner($this.parent().data("number"));var $channelPopup=$channelBanner.clone();$channelPopup.addClass("channel-compare-desc");var $closeButton=$("<button>",{"class":"channel-compare-desc__close",type:"button",title:"Закрыть"});$channelPopup.append($closeButton);$channelPopup.css("top",($channels_list.position().top+$this.position().top));$channelPopup.insertAfter($channels_list);$container.setMod("overlay","on");setTimeout(function(){$container.on("click.compare",function(){$channelPopup.remove();$(this).delMod("overlay").off("click.compare")})},1000);$closeButton.on("click.compare",function(){$channelPopup.remove();$container.delMod("overlay").off("click.compare")})}onChangePackFilter();return{wasExitOnConnect:function(){return isExitOnConnect},getSelectedPackKeys:function(){var selectedPackKeys=[];for(var i in packKeys){if(selection[i]){selectedPackKeys.push(packKeys[i])}}return selectedPackKeys},beforeOpen:function(){isExitOnConnect=false}}};