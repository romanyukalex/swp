(function(){TariffPlan=function(options){this.id="tariff-plan";this["class"]="";this.data={};this.el=$("<div></div>");this.tariffs=[];this.services=[];this.defaults={tpl_path:"/tpls/tariff_plan.hbs"};this.options={};this.tpl={};this.hasShpd=false;this.hasIptv=false;this.hasPhone=false;if(typeof options!=="undefined"){this.options=$.extend(this.defaults,options);this.id=this.options.id;this["class"]=this.options["class"];this.data=this.options.data;if(typeof options.tpl!=="undefined"){this.tpl=options.tpl}else{this.tpl=new TemplateClass(this.options.tpl_path);this.tpl.load()}}this.addTariff=function(tariff){if(tariff.type=="shpd"||tariff.type=="packet"){this.hasShpd=true}if(tariff.type=="iptv"){this.hasIptv=true}if(tariff.type=="pstn"){this.hasPhone=true}for(var t in tariff.tags){if($.inArray(tariff.tags[t].id,[329,330,331,332])>-1){this.isCorrectPrice=true;this.correctPriceTag=tariff.tags[t].id;break}else{if($.inArray(tariff.tags[t].id,[237,338,339,340,341]>-1)){this.isCrazyDays=true;break}}}this.tariffs.push(tariff)};this.loadTariffs=function(){var _this=this;if(_this.data.is_load==false){if(adrMgr.selectedRegion.klRegion==50&&_this.data.tag_id==312){_this.data.tag_id=289}var tag_tariffs="/pages/proxy.jsp?proxyType=agent&proxyMethod=GET&urlCode=tag_tariffs&tag="+_this.data.tag_id+"&local_id="+_this.data.mpzCode+"&region="+_this.data.reg_id;$.ajax(tag_tariffs,{dataType:"json"}).done(function(data){$("#tariffLoader").hide();if(adrMgr.selectedRegion.klRegion==50&&_this.data.tag_id==289){_this.data.tag_id=312}_.each(data,function(trf){trf.mode=trf.type;trf.type=(trf.type=="packet")?"shpd":trf.type;_.each(_this.tariffs,function(plan_trf){if(typeof plan_trf.services==="undefined"){plan_trf.services={}}if(plan_trf.id==trf.id){if(typeof plan_trf.services[trf.type]==="undefined"){plan_trf.services[trf.type]=trf}}else{if(trf.type=="iptv"){if(typeof plan_trf.services[trf.type]==="undefined"){_this.hasIptv=true;plan_trf.services[trf.type]=trf;for(var chIdx=0;chIdx<trf.choices.length;chIdx++){if((trf.choices[chIdx].name=="karaoke"||trf.choices[chIdx].name=="iptv_multiroom")&&trf.choices[chIdx].options[0].fee==0){trf.choices[chIdx].options[0].required=true}}}}if(trf.type=="pstn"){if(typeof plan_trf.services[trf.type]==="undefined"){_this.hasPhone=true;plan_trf.services[trf.type]=[]}plan_trf.services[trf.type].push(trf)}}})});_this.el.trigger("loadDone");_this.data.is_load=true}).fail(function(){_this.el.trigger("loadFail")}).always(function(){_this.el.trigger("load")})}};this.declOfNum=function(number,titles){cases=[2,0,1,1,1,2];return titles[(number%100>4&&number%100<20)?2:cases[(number%10<5)?number%10:5]]};this.render=function(){var _this=this;this.data.label=this.data.title;this.data.internet_tariffs=[];this.data.sections=[];this.data.add_fee=0;_.each(this.tariffs,function(tariff){if(_this.data.type=="packet"){_.each(tariff.services,function(service){if(service!=null){if(service.type=="iptv"&&typeof service.packages!=="undefined"){_this.data.add_fee=(service.packages.prices.singleplay[1]/100)+(service.packages.prices.doubleplay[1]/100)}}})}if(_this.data.url[_this.data.url.length-1]=="/"){_this.data.url=_this.data.url.substr(0,_this.data.url.length-1)}var section={type:_this.data.type,url:_this.data.url,tag_id:_this.data.tag_id,tariffId:tariff.id,action:_this.data.action};if(typeof tariff.type!=="undefined"&&tariff.type=="shpd"){section.shpd={fee:(tariff.fee/100),speed:(tariff.speed<1024?tariff.speed:tariff.speed/1024),speedSlow:(tariff.speed<1024?1:0),feeWithIPTV:(tariff.feeWithIPTV/100),packet_available:tariff.packet_available,action:tariff.action,isAction:tariff.isAction,descrAction:tariff.descrAction,deviceComment:tariff.deviceComment,tariffComment:tariff.tariffComment,isShowTariffComment:tariff.isShowTariffComment,isShowTariffCommentBlack:$.inArray(_this.data.tag_id,[286,237,338,339,340,341])>-1,feeAfterWithIPTV:(tariff.feeAfterWithIPTV/100),isNewPrice:((tariff.feeAfterWithIPTV/100)>(tariff.feeWithIPTV/100)?true:false),channelsCount:tariff.channelsCount,channelsLabel:_this.declOfNum(tariff.channelsCount,["канал","канала","каналов"]),channelsLabelWithTele:_this.declOfNum(tariff.channelsCount,["телеканала","телеканалов","телеканалов"]),name:_this.data.title,label:"до "+((tariff.speed<1024?tariff.speed:tariff.speed/1024)),techId:tariff.techId,techComment:tariff.techComment,isVolga:mrf.isVt(adrMgr.selectedRegion.klRegion),isMO:(adrMgr.selectedRegion.klRegion==50?true:false),desc:"Подходит для серфинга в интернете, работы с почтой, скачивания торрентов",icons:[{ico:"icon-inet-capability_serf",text:"Сайты"},{ico:"icon-inet-capability_mail",text:"Почта"},{ico:"icon-inet-capability_socnet",text:"Соцсети"},{ico:"icon-inet-capability_wifi",text:"Раздача Wi-Fi"}]};var speedMBit=tariff.speed/1024;if(speedMBit>10){section.shpd.icons.push({ico:"icon-inet-capability_music",text:"Музыка"});if(speedMBit>30){section.shpd.icons.push({ico:"icon-inet-capability_games",text:"Игры"});section.shpd.icons.push({ico:"icon-inet-capability_video-hd",text:"HD-видео"})}else{section.shpd.icons.push({ico:"icon-inet-capability_video",text:"Видео"})}}var prefixUrl="";if(typeof addressUrl!=="undefined"){prefixUrl=addressUrl}else{try{if(adrMgr.selectedCity.id!==adrMgr.selectedRegion.mainLocality.id){prefixUrl="/"+(adrMgr.other?"other":adrMgr.selectedCity.synonym)+"/"}}catch(error){prefixUrl=""}}var packetUrl=prefixUrl;switch(section.tag_id){case 218:packetUrl+="packages/tariffs/tvin_fast";break;case 219:packetUrl+="packages/tariffs/tvin";break;case 286:packetUrl+="packages/tariffs/strong";break;default:if($.inArray(section.tag_id,[237,337,338,340,339,341])!=-1){if(adrMgr.selectedRegion.klRegion=="50"){packetUrl+="packages/tariffs"}else{packetUrl+="packages/tariffs/grazy_days"}}break}if(packetUrl[packetUrl.length-1]=="/"){packetUrl=packetUrl.substr(0,packetUrl.length-1)}if(packetUrl[0]!="/"){packetUrl="/"+packetUrl}section.packetUrl=packetUrl;if(section.url.indexOf(prefixUrl)===-1){section.url=prefixUrl.substring(0,prefixUrl.length-1)+section.url}section.shpd.ico=utils.getTariffSpeedIco(tariff.speed);if(typeof _this.isCorrectPrice!=="undefined"){if($.inArray(section.tag_id,[329,330,331,332])>-1){section.isCorrectPrice=true;section.isVolga=mrf.isVt(adrMgr.selectedRegion.klRegion);section.isUral=mrf.isUral(adrMgr.selectedRegion.klRegion);section.isCenter=mrf.isCenter(adrMgr.selectedRegion.klRegion)}}if($.inArray(section.tag_id,[218,219,297,298])>-1){section.shpd.hidePromo=true}else{section.shpd.hidePromo=false}_this.data.sections.push(section);utils.log(section.shpd)}});_this.data.sections=_.sortBy(_this.data.sections,function(section){return section.shpd.speed});_this.data.internet_tariffs=_.sortBy(_this.data.internet_tariffs,function(tariff){return tariff.speed});if(typeof this.isCorrectPrice!=="undefined"){this.data.isCorrectPrice=true}if(this.data){this.el.html(this.tpl.render(this.data)).attr("id",this.id).addClass(this["class"])}this.el.find(".tariff-desc__capability").each(function(){$(this).find(".service-capability-label").last().addClass("service-capability-label_stand-alone")});this.binds();return this};this.renderActiveState=function(){var _this=this;$(".tariffs-swiper .unit-tariff").removeClass("unit-tariff_selected-true");$(".tariffs-swiper .unit-tariff__connect").removeClass("unit-tariff__connect_active-true");_this.el.find(".unit-tariff").addClass("unit-tariff_selected-true");_this.el.find(".unit-tariff__connect").addClass("unit-tariff__connect_active-true")};this.binds=function(){var _this=this;this.el.find(".unit-tariff__sel").on("change",function(e){var tariff_id=$(e.currentTarget).val();var fee=0;_.each(_this.tariffs,function(tariff){if(tariff.id==tariff_id){tariff.choice=true}else{tariff.choice=false}if(tariff.choice){fee=tariff.fee+tariff.add_fee}});_this.el.find(".cost-rubmonth").html(fee);_this.el.trigger("choice_tariff",[e,_this])});this.el.find(".unit-tariff__connect-inp").on("change",function(el){_this.renderActiveState();_this.el.trigger("choice",_this)});this.el.find(".js-forward-to-form").on("click",function(event){var el=$(this);var form=el.parent();if(!form.attr("action")){form.attr("action",el.attr("href"))}form.submit();event.preventDefault()})};return this}})();