(function(){var ERR_MSG="Произошла ошибка при сохранении заявки, попробуйте, пожалуйста, позже";var addressInfo=app.addr?app.addr:(app.addr=new AddressInfo());$(".js-b2b-custom-order").each(function(){var $this=$(this);var tag=$this.data("tag");var userNote=$this.data("user-note");var errorMessage=$this.data("error-message")||ERR_MSG;var $firstName=$this.find('[name="first-name"]'),$lastName=$this.find('[name="last-name"]'),$fio=$this.find('[name="fio"]'),$notify=$this.find('[name="notify"]'),$email=$this.find('[name="email"]'),$phone=$this.find('[name="phone"]'),$userNote=$(this).find('[name="user-note"]'),$company=$(this).find('[name="company"]');if(utils.isEmpty(tag)||utils.isEmpty(userNote)&&!$userNote.length||!$email.length||!$phone.length||!$firstName.length&&!$lastName.length&&!$fio.length){utils.error("can not to bind b2b-custom-order form");return}$this.find(".js-city").text(adrMgr.other?adrMgr.other.name:adrMgr.selectedCity.name,null,true);$this.find(".js-city").click(function(){$.smoothScroll();$(".location-label").trigger("click")});var orderApi=new OrderAPI(tag);addressInfo.connect_form(window.adrMgr.other||window.adrMgr.selectedCity);function clearForm(){$firstName.add($lastName).add($fio).add($email).add($phone).add($userNote).add($company).add($this.find('[name="street"],[name="build"],[name="flat"]')).val("").validatorFilter("reinit");$notify.prop("checked",false)}$this.find(".js-send").click(function(){var loaderId=$(this).attr("id");if(!utils.buttonLoader(loaderId)){return}var notify=$notify.is(":checked")?1:0;var order={individual:1,userNote:$userNote.length?$userNote.val():userNote,notifyBySMS:notify,notifyByEmail:notify,companyName:$company.val(),email:$email.val(),cellPhone:$phone.val()};var address=addressInfo.address_process();$.extend(order,{region:address.region,city:address.city,cityId:address.cityId,street:address.street,streetId:address.streetId,house:address.house,houseId:address.houseId,flat:address.flat});$.extend(order,getNames($firstName,$lastName,$fio));orderApi.clear();orderApi.orderData=order;orderApi.createOrder();orderApi.send(function(data){if(data.isError){utils.Error(data.errorMsg||errorMessage,"Ошибка")}else{var popupId=$this.data("success-popup");var $popup=$();if(!utils.isEmpty(popupId)){$popup=$("#"+popupId)}if($popup.length){$popup.find(".js-order-id").text(data.result.orderId);$popup.find(".js-order-fio").text(orderApi.getFIO);$.magnificPopup.open({items:{src:$popup},type:"inline",callbacks:{afterClose:function(){clearForm()}},closeBtnInside:false,showCloseBtn:false})}else{utils.Notice("Ваша заявка №"+data.result.orderId+" успешно сохранена")}}utils.buttonUnLoader(loaderId)},{},true,"create_corp_order")})});function getNames($firstName,$lastName,$fio){var names={};if(!$firstName.length&&!$lastName.length){var fio=$.trim($fio.val()).split(" ");if(fio.length==1){names.firstName=fio[0];names.lastName="";names.middleName=""}else{if(fio.length==2){names.firstName=fio[1];names.lastName=fio[0];names.middleName=""}else{names.lastName=fio[0];names.firstName=fio[1];names.middleName=fio[2]}}}else{names.firstName=$.trim($firstName.val());names.middleName="";names.lastName=$.trim($lastName.val())}return names}})();