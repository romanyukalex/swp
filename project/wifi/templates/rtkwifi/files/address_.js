(function(){AddressInfo=function(){this.city={};this.street={};this.house={};this.flat={};this.regionId="";this.addrResponse={};this.checkPosResult={result:false};var SVC_LIST={"1":{name:"Интернет"},"2":{name:"ТВ"},"3":{name:"Телефон"}};this.tech_region=["22","75","38","42","42","24","54","55","04","03","17","19","70","69","68","62","31","32","33","44","36","37","40","48","57","67","71","46","76","27","28","79","41","49","25","65","14","18","43","02","12","13","52","56","58","63","64","73","21","16","78","29","35","39","47","51","53","60","10","11","50"];this.tech_region_without_house=["45","59","66","72","74","86","89","30","34","23","01","05","07","08","09","61","15","26","06"];this.regions_with_required_address=[{klRegion:"50",klCode:["5000200100000","5001700100000"],klCode1:["5002000200000","5000200100000","5000000200000","5001400100000","5000400100000","5000900200000","5000002300000","5000500100000","5000002900000","5000600100000","5000700100000","5000000400000","5000000500000","5000000700000","5000900100000","5001000100000","5001100100000","5000002700000","5000000900000","5002400400000","5000001200000","5004000200000","5001600100000","5001700100000","5001800100000","5001900100000","5002000100000","5002100100000","5002200100000","5000002600000","5002500100000","5000002400000","5000001400000","5002700100000","5000001600000","5003000500000","5000002800000","5003400100000","5000001900000","5000003000000","5003700100000","5003800100000","5004000100000","5000002100000","5002400000600","5001700400000","5003300100000"],typeSend:0},{klRegion:"39"},{klRegion:"36"},{klRegion:"22"},{klRegion:"25"},{klRegion:"73"},{klRegion:"61"},{klRegion:"31",klCode:["3100000100000"]},{klRegion:"32",klCode:["3200000100000"]},{klRegion:"33",klCode:["3300000100000"]},{klRegion:"37",klCode:["3700000100000"]},{klRegion:"40",klCode:["4000000100000"]},{klRegion:"46",klCode:["4600000100000"]},{klRegion:"48",klCode:["4800000100000"]},{klRegion:"57",klCode:["5700100100000"]},{klRegion:"62",klCode:["6200000100000"]},{klRegion:"67",klCode:["6700000300000"]},{klRegion:"68",klCode:["6800000400000"]},{klRegion:"69",klCode:["6900100100000"]},{klRegion:"71",klCode:["7100000100000"]},{klRegion:"76",klCode:["7600000100000"]},{klRegion:"14"},{klRegion:"41"}];if(!isTest){$(this.regions_with_required_address).each(function(){if(this.klCode&&this.klCode1){this.klCode=this.klCode.concat(this.klCode1)}delete this.klCode1})}$(this.regions_with_required_address).each(function(){this.typeSend=0});var settime,last_time=0;this.street_list=function(params,callback,$place,curr_time){var _this=this;if(params=="undefined"||callback=="undefined"){return}$.ajax({url:window.docContext.properties.searchUrl+"ajax/search_street",dataType:"jsonp",type:"post",data:params,async:true,cache:false}).done(function(data){var res=data.result;if(typeof res!=="undefined"){isStreetResult=true;streetIndex=-1;streetCount=res.length;if(res.length>0&&$place.is(":focus")&&curr_time>last_time){last_time=curr_time;if(callback){callback(res)}}else{$(".help-search__address").removeClass("help-search_state-focus").addClass("help-search_state");$("#addrlist_street").html("").hide();if(res.length==0){$(_this.street.selector).trigger("address-is-not-found")}}}else{$(".help-search__address").removeClass("help-search_state-focus").addClass("help-search_state");$("#addrlist_street").html("").hide();$(_this.street.selector).trigger("address-is-not-found")}}).fail(function(){isStreetResult=false})};this.house_list=function(params,callback,$place,curr_time){var _this=this;if(params=="undefined"||callback=="undefined"){return}params.proxyType="agent";$.ajax({url:"/pages/proxy.jsp",dataType:"json",type:"post",data:params}).done(function(data){var res=data;if(typeof res!=="undefined"){isHouseResult=true;houseIndex=-1;houseCount=res.length;if(res.length>0&&$place.is(":focus")&&curr_time>last_time){last_time=curr_time;if(callback){callback(res)}}else{$(".help-search__house").removeClass("help-search_state-focus").addClass("help-search_state");$("#addrlist_house").html("").hide();if(res.length==0){$(_this.house.selector).trigger("address-is-not-found")}}}else{$(".help-search__house").removeClass("help-search_state-focus").addClass("help-search_state");$("#addrlist_house").html("").hide();$(_this.house.selector).trigger("address-is-not-found")}}).fail(function(){isHouseResult=false})};this.checkTechPos=function(params,svcClassId,callback){if(!params){params={}}params.svcClassId=svcClassId;params.proxyType="mpz";params.urlCode="tech_poss";params.proxyMethod="POST";$.ajax({url:"/pages/proxy.jsp",type:"post",data:params,dataType:"text"}).done(function(data){var res=eval("("+data+")");if(typeof res!=="undefined"){if(callback){if(res){res.svcClassId=svcClassId}callback(res)}}}).fail(function(){utils.log("tech_poss")}).complete(function(){if(--_this.await_check_count==0){_this.check_complete()}})};this.setRegion=function(region){this.regionId=region};this.setCity=function(defaultVal){var _this=this;_this.addrResponse.city={};_this.addrResponse.city.results=[{id:defaultVal.mpzCode,info:defaultVal.name}];_this.addrResponse.city.select={id:defaultVal.mpzCode,info:defaultVal.name};_this.addrResponse.street=undefined};var streetIndex=-1,isStreetResult=false,streetCount=0;this.setStreetArrowHandler=function(){var $search=$(".address_street");streetIndex=-1;isStreetResult=false;streetCount=0;$search.unbind("keydown.arrow-handler").bind("keydown.arrow-handler",function(e){var $helplist=$search.parent(".help-search").find(".help-search__list");if($helplist.size()>0&&isStreetResult&&streetCount>0){var changed=false;if(e.which==38){streetIndex=Math.max(streetIndex-1,0);changed=true}else{if(e.which==40){streetIndex=Math.min(streetIndex+1,streetCount-1);changed=true}else{if(e.which==13){if(streetIndex>-1){$helplist.find("li").eq(streetIndex).trigger("mousedown").trigger("click")}}}}if(changed){checkScroll($helplist.find("li").removeClass("location-top__helplist-item_active").eq(streetIndex).addClass("location-top__helplist-item_active"),$helplist.parent(".help-search__listwrap"))}}})};this.street.selector=".address_street";this.setStreet=function(withoutConnect){var _this=this;_this.street.select="";_this.addrResponse.street={results:[],select:{id:"",info:(!!$(_this.street.selector).val()?$(_this.street.selector).val().substring(0,3):"")}};if(withoutConnect){return}$(_this.street.selector).after('<div id="addrlist_street" class="help-search__listwrap help-search__listwrap_state-on"/>');$("#addrlist_street").hide();$(_this.street.selector).bind("input",function(){var $input=$(_this.street.selector),street_val=$.trim($input.val());$("#addrlist_street").hide();if(settime){clearTimeout(settime);settime=null}if(street_val.length>=3){$(".help-search__address").removeClass("help-search_state").addClass("help-search_state-focus");_this.addrResponse.street.select={id:"",info:street_val};var params={kladr:_this.regionId,query:street_val,mpzCode:_this.getCityCode()};$(_this.street.selector).trigger("address-reset-select");var qq=function(){_this.street_list(params,function(data){if(!data||data.length==0){$(_this.street.selector).trigger("address-is-not-found")}if(typeof data!=="undefined"){_this.addrResponse.street.results=data;$(_this.street.selector).trigger("address-is-found");var $list=$("#addrlist_street");$list.html(create_list_addr(data,street_val,"street"));$list.show();initScroll($list,10);$list.find(".help-search__item").unbind("mousedown").bind("mousedown",function(data){_this.addrResponse.street.select={id:$(this).attr("data-id"),info:$(this).text()};$(_this.street.selector).val($(this).text()).trigger("address-select")}).unbind("click").bind("click",function(e){$("#addrlist_street").html("").unbind("click").hide();$(".help-search__address").removeClass("help-search_state-focus").addClass("help-search_state");_this.rules()});$list.find("ul").bind("mousedown",function(){$(this).data("click-on-list",true)})}},$input,(new Date()).getTime())};if(!settime){settime=setTimeout(qq,50)}_this.street.select=street_val.substring(0,3)}else{_this.addrResponse.street.results=[];_this.addrResponse.street.select={id:"",info:street_val};_this.street.select=""}});$(_this.street.selector).bind("blur",function(){var $list=$("#addrlist_street"),$ul=$list.find("ul");if(!$ul.data("click-on-list")){$list.hide();$(".help-search__address").removeClass("help-search_state-focus").addClass("help-search_state")}else{$(this).focus();$ul.data("click-on-list",false)}})};var houseIndex=-1,isHouseResult=false,houseCount=0;this.setHouseArrowHandler=function(){var $search=$(".address_house");houseIndex=-1;isHouseResult=false;houseCount=0;$search.unbind("keydown.arrow-handler").bind("keydown.arrow-handler",function(e){var $helplist=$search.parent(".help-search").find(".help-search__list");if($helplist.size()>0&&isHouseResult&&houseCount>0){var changed=false;if(e.which==38){houseIndex=Math.max(houseIndex-1,0);changed=true}else{if(e.which==40){houseIndex=Math.min(houseIndex+1,houseCount-1);changed=true}else{if(e.which==13){if(houseIndex>-1){$helplist.find("li").eq(houseIndex).trigger("mousedown").trigger("click")}}}}if(changed){checkScroll($helplist.find("li").removeClass("location-top__helplist-item_active").eq(houseIndex).addClass("location-top__helplist-item_active"),$helplist.parent(".help-search__listwrap"))}}})};this.setHouse=function(withoutConnect){var _this=this;_this.house.selector=".address_house";_this.house.select=$(_this.house.selector).val();_this.addrResponse.house={results:[],select:{id:"",info:$(_this.house.selector).val()}};if(withoutConnect){return}$(_this.house.selector).after('<div id="addrlist_house" class="help-search__listwrap help-search__listwrap_state-on"/>');$("#addrlist_house").hide();$(_this.house.selector).bind("input",function(e){var $input=$(_this.house.selector);house_val=$.trim($input.val());$(".help-search__house").removeClass("help-search_state").addClass("help-search_state-focus");$("#addrlist_house").hide();if(settime!=null){clearTimeout(settime);settime=null}if(house_val.length>=1){_this.addrResponse.house.select={id:"",info:house_val};var streetCode="";if(typeof _this.addrResponse.street.select!=="undefined"){streetCode=_this.addrResponse.street.select.id}var params={region:_this.regionId,localId:streetCode,house:$(_this.house.selector).val(),urlCode:"get_houseinfo"};$(_this.house.selector).trigger("address-reset-select");var qq=function(){_this.house_list(params,function(data){if(!data||data.length==0){$(_this.house.selector).trigger("address-is-not-found")}if(typeof data!=="undefined"){if(data.length==0){_this.addrResponse.house.results=[];return}_this.addrResponse.house.results=data;$(_this.house.selector).trigger("address-is-found");var $list=$("#addrlist_house");$list.html(create_list_addr(data,house_val,"house"));$list.show();initScroll($list,10);$list.find(".help-search__item").unbind("mousedown").bind("mousedown",function(data){_this.addrResponse.house.select={id:$(this).attr("data-id"),info:$(this).text()};$(_this.house.selector).val($(this).text()).trigger("address-select")}).unbind("click").bind("click",function(data){$("#addrlist_house").html("").hide();$(".help-search__house").removeClass("help-search_state-focus").addClass("help-search_state");_this.rules()});$list.find("ul").bind("mousedown",function(){$(this).data("click-on-list",true)})}},$input,(new Date()).getTime())};if(params.localId){if(!settime){settime=setTimeout(qq,50)}}_this.house.select=house_val.substring(0,1)}else{_this.addrResponse.house.results=[];_this.addrResponse.house.select={id:"",info:house_val.substring(0,1)};_this.house.select=""}});$(_this.house.selector).bind("blur",function(){var $list=$("#addrlist_house"),$ul=$list.find("ul");if(!$ul.data("click-on-list")){$list.hide();$(".help-search__house").removeClass("help-search_state-focus").addClass("help-search_state")}else{$(this).focus();$ul.data("click-on-list",false)}})};this.setFlat=function(func,withoutConnect){var _this=this;_this.flat.selector=".address_flat";_this.flat.select=$(_this.flat.selector).val();_this.addrResponse.flat={results:[],select:{id:"",info:$(_this.flat.selector).val()}};if(withoutConnect){return}$(_this.flat.selector).bind("input",function(e){var flat_val=$.trim($(_this.flat.selector).val());if(settime!=null){clearTimeout(settime);settime=null}if(flat_val.length>=1){_this.addrResponse.flat.select={id:"",info:flat_val};var qq=function(){_this.addrResponse.flat.select={id:"s_this_mark",info:flat_val};_this.rules(func)};if(!settime){settime=setTimeout(qq,50)}}else{_this.addrResponse.flat.results=[];_this.addrResponse.flat.select={id:"",info:flat_val.substring(0,1)};_this.flat.select=""}})};this.initProcess=function(func){var _this=this;_this.flat.selector=".address_flat";$(".address_street,.address_house,.address_flat").bind("input",function(){var $flat=$(".address_flat");if($(this).hasClass("address_street")){if($(".address_house").val().length>0){$(".address_house").val("").trigger("change.placeholder")}if($flat.size()>0&&$flat.val().length>0){$flat.val("").trigger("change.placeholder")}}if($(this).hasClass("address_house")){if($flat.size()>0&&$flat.val().length>0){$flat.val("").trigger("change.placeholder")}}_this.setFlat(func)})};function create_list_addr(res,element,streetOrHouse){var html='<ul class="help-search__list">';var index=0;if(streetOrHouse=="street"){for(el in res){if(res[el].name.toLowerCase().indexOf(element.toLowerCase())>-1){html+='<li class="help-search__item" data-id="'+res[el].mpzCode+'" data-index = "'+index+'">';var ind=res[el].name.toLowerCase().indexOf(element.toLowerCase());html+=res[el].name.substring(0,ind);html+='<span class="help-search__item-main-text">'+res[el].name.substring(ind,ind+element.length)+"</span>";html+=res[el].name.substring(ind+element.length,res[el].name.length);html+="</li>";index++}}}if(streetOrHouse=="house"){for(el in res){if(res[el].value.toLowerCase().indexOf(element.toLowerCase())>-1){html+='<li class="help-search__item" data-id="'+res[el].id+'" data-index = "'+index+'">';html+="<nobr>";var ind=res[el].value.toLowerCase().indexOf(element.toLowerCase());html+=res[el].value.substring(0,ind)+'<span class="help-search__item-main-text">'+res[el].value.substring(ind,ind+element.length+1)+"</span>"+res[el].value.substring(ind+element.length+1,res[el].value.length);html+="</nobr>";html+="</li>";index++}else{html+='<li class="help-search__item" data-id="'+res[el].id+'" data-index = "'+index+'"><nobr><span class="help-search__item-main-text">'+res[el].value+"</span></nobr></li>";index++}}}html+="</ul>";return html}function initScroll($list,limit){var $ul=$list.find("ul"),allHeight=0,maxHeight=0;$ul.find("li").each(function(i,li){var delta=$(li).outerHeight(true);allHeight+=delta;if(i<limit){maxHeight+=delta}});var cssMaxHeight=utils.toInt($ul.css("max-height"));if(cssMaxHeight&&maxHeight>cssMaxHeight){maxHeight=cssMaxHeight}if(allHeight>maxHeight){$list.data("has-scroll",true);$list.css({"max-height":maxHeight,overflow:"auto"})}else{$list.data("has-scroll",false);$list.css({"max-height":"auto"})}}function checkScroll($current,$container){if($container.data("has-scroll")){var oldScrollTop=$container.find("ul").scrollTop(),newScrollTop=$current.offset().top-$container.offset().top+oldScrollTop;if(newScrollTop<oldScrollTop||newScrollTop>=oldScrollTop+$container.innerHeight()-$current.outerHeight(true)){$container.find("ul").scrollTop(newScrollTop)}}}this.tech_check_time=0;this.rules_try_count=0;this.await_check_count=0;this.rules=function(func){if($.inArray(this.regionId,this.tech_region)>-1&&this.addrResponse.house.select.id.length>1||$.inArray(this.regionId,this.tech_region_without_house)>-1&&this.addrResponse.house.select.info.length>0){if(this.addrResponse.street.select.id.length>1&&this.addrResponse.flat.select.id.length>1){this.checkPosResult.result=false;var time=new Date().getTime();this.tech_check_time=time;this.rules_try_count++;var isOnePstn=false;if(window.location.pathname.indexOf("/fastorder")>=0){var srvs={shpd:false,iptv:false,pstn:false};$("input[name=iptv]:checked , input[name=homeinet]:checked, input[name=phone]:checked").each(function(){var name=$(this).attr("name");name=$(this).attr("name")==="homeinet"?"shpd":name;name=$(this).attr("name")==="phone"?"pstn":name;srvs[name]=true});if(!srvs.shpd&&!srvs.iptv&&srvs.pstn){isOnePstn=true}}this.connChecks=[];this.check_reset();if(isOnePstn){this.tech_check(func,"3",time);this.await_check_count++}else{this.tech_check(func,"2",time);this.tech_check(func,"1",time);this.await_check_count+=2}}}return false};this.check=function(func){sAddress="";sAddressWithFlat="";var result={};var _this=this;var cityCode,flat,house,houseCode,isPhoneCheck=0,level,streetCode,phone="",region;if(_this.addrResponse.city!=undefined){if(_this.addrResponse.city.select!=undefined){cityCode=_this.addrResponse.city.select.id}}flat=$(_this.flat.selector).val();house=$(_this.house.selector).val();if(_this.addrResponse.house!=undefined){if(_this.addrResponse.house.select!=undefined){if(_this.addrResponse.house.select.info==house){houseCode=_this.addrResponse.house.select.id}}}if(_this.addrResponse.street!=undefined){if(_this.addrResponse.street.select!=undefined&&_this.addrResponse.street.select.info==$.trim($(_this.street.selector).val())){streetCode=_this.addrResponse.street.select.id}}region=_this.regionId;if(!cityCode||!flat||!house||!streetCode||!region){result.OK=false;return result}sAddress=_this.addrResponse.city.select.info+", "+_this.addrResponse.street.select.info+", "+house;sAddressWithFlat=sAddress+(flat?", квартира "+flat:"");address={};address.cityId=cityCode;address.streetId=streetCode;address.house=house;address.houseId=houseCode;address.flat=flat;var params={};params.cityId=address.cityId;if(address.flat){params.flat=address.flat}params.house=address.house;params.isPhoneCheck=isPhoneCheck;params.phone=phone;params.region=region;params.houseId=address.houseId;params.streetId=address.streetId;result.params=params;result.OK=true;return result};this.techCapIds=[];this.saveTechCapStat=function(serviceName,techResult){var params={};params.serviceName=serviceName;params.techResult=techResult;params.userUuid=window.docContext.userUuid;params.requestUuid=window.docContext.requestUuid;params=this.address_process(params);$.ajax({url:"/ajax/sendStat/techCapability",type:"post",data:params,dataType:"json",async:true,cache:false,success:function(resp){if(typeof resp.result!=="undefined"&&resp.result>-1){app.addr.techCapIds.push(resp.result)}}})};this.getTechCapIds=function(){var ids=this.techCapIds;this.techCapIds=[];return ids};this.connChecks=[];this.getConnChecks=function(svcClassId){if(!svcClassId){return[]}var svcConnChecks=[];for(var i in this.connChecks){var connCheckEntry=this.connChecks[i];if(connCheckEntry.svcClassId==svcClassId){svcConnChecks.push(connCheckEntry.connCheck)}}return svcConnChecks};this.resetConnChecks=function(){this.connChecks=[]};this.getResult=function(results,func,isLate){var message="";var check=false;try{for(key in SVC_LIST){SVC_LIST[key].check=false}for(var key in SVC_LIST){var result=results[key];if(result){var connCheckResults=[];for(var key1 in result.check.techPos){var tech=result.check.techPos[key1];if(tech.res=="Y"||tech.res=="E"){SVC_LIST[key].check=true}connCheckResults.push({TechId:tech.TechId,descr:tech.descr,maxSpeed:tech.maxSpeed,res:tech.res})}var street=result.check.instAdrStreet,house=result.check.instAdrHouse,flat=result.check.flat;this.connChecks.push({svcClassId:key,connCheck:{address:this.getCityName()+", "+(utils.isEmpty(street)?this.addrResponse.street.select.info:street)+", д. "+(utils.isEmpty(house)?this.addrResponse.house.select.info:house)+", кв. "+(utils.isEmpty(flat)?this.addrResponse.flat.select.info:flat),phone:result.check.phone,timestamp:utils.toInt(result.timestamp),type:1,result:connCheckResults}});this.saveTechCapStat(SVC_LIST[key].name,SVC_LIST[key].check)}}var sCheckServices="";var checkServiceCount=0;for(key in SVC_LIST){var svc=SVC_LIST[key];if(svc.check){check=true;checkServiceCount++;sCheckServices+=(sCheckServices?" и ":"")+svc.name}}if(!check){if(!isLate){this.checkPosResult.result=false;$(".address_message").html("").hide()}}else{if(!isLate){var s=checkServiceCount>1?"доступны услуги ":"доступна услуга ";message="Ваш дом подключен к услугам Ростелекома!";this.checkPosResult.result=true;$(".address_message").html(message).show();if(typeof func!=="undefined"){func()}}}}catch(e){if(!isLate){this.checkPosResult.result=false;$(".address_message").html("").hide()}}};this.tech_check=function(func,svcClassId,time){var check=this.check();var _this=this;$(".address_message").html("").show();$(".address_block_tech").hide();if(check.OK){var results={};this.checkTechPos(check.params,svcClassId,function(result){if(time==_this.tech_check_time){if(result&&result.svcClassId){results[result.svcClassId]=result}_this.getResult(results,func,_this.checkPosResult.result)}})}else{this.checkPosResult.result=false;$(".address_message").html("").hide();this.await_check_count--}};this.getCityCode=function(){if(this.addrResponse.city==undefined){return 0}else{if(this.addrResponse.city.select!=undefined){return this.addrResponse.city.select.id}else{return 0}}};this.getCityName=function(){if(this.addrResponse.city==undefined){return""}else{if(this.addrResponse.city.select!=undefined){return this.addrResponse.city.select.info}else{return""}}};this.address_process=function(param){var address={};if(typeof param!=="undefined"){address=param}address.region=this.regionId;address.city=this.addrResponse.city.select.info;address.cityId=this.addrResponse.city.select.id;address.street=this.addrResponse.street.select.info;address.streetId=this.addrResponse.street.select.id;address.house=this.addrResponse.house.select.info;address.houseId=this.addrResponse.house.select.id;address.flat=$.trim($(this.flat.selector).val());if(utils.isEmpty(address.street)){address.street=$(this.street.selector).val()}if(utils.isEmpty(address.house)){address.house=$(this.house.selector).val()}return address};this.setSuggestablePartOfAddress=function(address){this.addrResponse.street.select.info=address.street;this.addrResponse.street.select.id=address.streetId;this.addrResponse.house.select.id=address.houseId;this.addrResponse.house.select.info=address.house};this.connect_form=function(defaultVal,func,withoutConnect){withoutConnect=!utils.isEmpty(withoutConnect);this.setRegion(defaultVal.klRegion);this.setCity(defaultVal);this.setStreet(withoutConnect);this.setStreetArrowHandler();this.setHouse(withoutConnect);this.setHouseArrowHandler();this.initProcess(func,withoutConnect);this.bindButtonSendToggle()};var _this=this;var addressHintIsBound=false;function toggleAddressHintClass($fields,className,isActive){$fields.each(function(){var $hint=$(this).data("address-hint");if($hint){$hint.toggleClass(className,isActive)}})}function bindAddressHint(params){addressHintIsBound=true;var $street=$(_this.street.selector),$house=$(_this.house.selector),$flat=$(_this.flat.selector),hasHouseDirectory=$.inArray(_this.regionId,_this.tech_region_without_house)==-1;if(params.mode=="required"){var $addresses=$street.add($house),needCheckStreet=false,needCheckHouse=false;$street.data("address-hint",validatorFilter.createCustomInputHint($street,"Введенная вами улица не найдена. Пожалуйста, выберите название улицы из выпадающего списка, это позволит сократить время обработки вашей заявки."));if(hasHouseDirectory){$house.data("address-hint",validatorFilter.createCustomInputHint($house,"Введенный вами номер дома не найден. Пожалуйста, выберите номер дома из выпадающего списка, это позволит сократить время обработки вашей заявки."))}$addresses.bind("blur",function(){var $hint=$(this).data("address-hint");if($hint){$hint.hide()}});$street.bind("address-reset-select",function(){needCheckStreet=needCheckHouse=false});$house.bind("address-reset-select",function(){needCheckHouse=false});$street.bind("address-is-found address-is-not-found",function(){needCheckStreet=true});$house.bind("address-is-found address-is-not-found",function(){needCheckHouse=true});function hasValidatorError($field){return $field.hasClass(validatorFilter.errorClass)&&$field.validatorFilter("filter-off").size()==0}$([{$field:$street,isNeedShow:function(){if(needCheckStreet&&$street.val().length>0){var addrInfo=_this.address_process();if(utils.isEmpty(addrInfo.streetId)){return true}}return false}},{$field:$house,isNeedShow:function(){if(needCheckHouse&&$house.val().length>0){var addrInfo=_this.address_process();if(utils.isEmpty(addrInfo.houseId)){return true}}return false}}]).each(function(i,item){item.$field.bind("focus input keyup address-is-not-found address-select",function(e){if(e.type=="keyup"&&!validatorFilter.isChanging(e)){return}var $this=$(this),$wrapper=$this.closest(".help-search");var isShow=false;if(!hasValidatorError($this)&&$wrapper.find(".help-search__list:visible").size()==0){isShow=item.isNeedShow()}var $hint=$this.data("address-hint");$hint.redraw();$hint.toggle(isShow)})}).first().each(function(i,item){var isFound=false;var isShowed=false;var checkField=function(needHide){isShowed=!needHide&&!hasValidatorError(item.$field)&&item.isNeedShow()&&isFound;var $hint=item.$field.data("address-hint");$hint.redraw();$hint.toggle(isShowed)};item.$field.bind("address-is-found",function(){isFound=true});item.$field.bind("address-reset-select address-is-not-found",function(){isFound=false});item.$field.bind("blur",function(){checkField()});$street.add($house).add($flat).not(item.$field).bind(validatorFilter.getEventString(validatorFilter.validateEvents),function(){var $this=$(this);if(hasValidatorError($this)){checkField(true)}}).bind("blur",function(){checkField()})});validatorFilter.additionalValidate($(_this.street.selector).closest(".validate_form"),function(){var addrInfo=_this.address_process();var isNotSelected=utils.isEmpty(addrInfo.streetId);if(isNotSelected){var $street=$(_this.street.selector),$house=$(_this.house.selector),$addresses=$street;var $first=$addresses.filter(":focus");if(!$first.length){$first=$addresses.first()}toggleAddressHintClass($addresses,"error",true);$addresses.validatorFilter("off");$addresses.addClass(validatorFilter.errorClass);$first.focus();var events=validatorFilter.getEventString(validatorFilter.changeEvents,utils.unique());$addresses.one(events,function(){$addresses.unbind(events);toggleAddressHintClass($addresses,"error",false);toggleAddressHintClass($addresses,"tipsy-attention",true);$addresses.removeClass(validatorFilter.errorClass);$addresses.validatorFilter("on");$addresses.validatorFilter("validate")})}return !isNotSelected})}else{if(params.mode=="callback"){$street.data("address-hint",validatorFilter.createCustomInputHint($street,"Начните вводить улицу и мы предложим Вам возможные варианты. Если в списке Вы не обнаружили своей улицы или дома, введите свои данные."));$street.bind("focus keyup",function(e){var $hint=$(this).data("address-hint");if($(this).val().length<3){var $wrapper=$(this).closest(".help-search");if(e.type=="keyup"){$(this).validatorFilter("validate")}var isShow=(!$(this).hasClass("input-error")&&$wrapper.find(".help-search__list:visible").size()==0);if(isShow){$hint.redraw();$hint.show()}else{$hint.hide()}}else{$hint.hide()}});$street.bind("blur",function(){var $hint=$(this).data("address-hint");$hint.hide()})}else{if(hasHouseDirectory){var $addresses=$street.add($house),needCheckStreet=false,needCheckHouse=false;$addresses.each(function(){var $this=$(this);$this.data("address-hint",validatorFilter.createCustomInputHint($this,"Введенный вами адрес не найден. Пожалуйста, выберите название улицы и номер дома из выпадающего списка, это позволит сократить время обработки вашей заявки."))});$addresses.bind("blur",function(){var $hint=$(this).data("address-hint");if($hint){$hint.hide()}});$street.bind("address-reset-select",function(){needCheckStreet=needCheckHouse=false});$house.bind("address-reset-select",function(){needCheckHouse=false});$street.bind("address-is-found address-is-not-found",function(){needCheckStreet=true});$house.bind("address-is-found address-is-not-found",function(){needCheckHouse=true});function isNeedShow(){if((needCheckStreet||needCheckHouse)&&$street.val().length>0&&$house.val().length>0){var addrInfo=_this.address_process();if((utils.isEmpty(addrInfo.streetId))&&needCheckStreet||(utils.isEmpty(addrInfo.houseId))&&needCheckHouse){return true}}return false}$addresses.bind("focus input keyup address-is-not-found address-select",function(e){if(e.type=="keyup"&&!validatorFilter.isChanging(e)){return}var $this=$(this),$wrapper=$this.closest(".help-search");var isShow=false;if(!$this.hasClass(validatorFilter.errorClass)&&$wrapper.find(".help-search__list:visible").size()==0){isShow=isNeedShow()}var $hint=$this.data("address-hint");if($hint){$hint.redraw();$hint.toggle(isShow)}});$flat.bind("focus input keyup",function(){var $hint=$house.data("address-hint");if($hint){$hint.redraw();$hint.toggle(!$(this).hasClass(validatorFilter.errorClass)&&isNeedShow())}});$flat.bind("blur",function(){var $hint=$house.data("address-hint");if($hint){$hint.hide()}})}else{var $addresses=$street.add($house),needCheck=false;$street.data("address-hint",validatorFilter.createCustomInputHint($street,"Введенная вами улица не найдена. Пожалуйста, выберите название улицы из выпадающего списка, это позволит сократить время обработки вашей заявки."));$addresses.bind("blur",function(){var $hint=$street.data("address-hint");if($hint){$hint.hide()}});$street.bind("address-reset-select",function(){needCheck=false});$street.bind("address-is-found address-is-not-found",function(){needCheck=true});var check=function(e){if(e.type=="keyup"&&!validatorFilter.isChanging(e)){return}var $this=$(e.target);var $hint=$street.data("address-hint");if($hint){var addrInfo=_this.address_process();$hint.redraw();$hint.toggle(needCheck&&!$this.hasClass(validatorFilter.errorClass)&&$this.closest(".help-search").find(".help-search__list:visible").size()==0&&$street.val().length>0&&(utils.isEmpty(addrInfo.streetId)))}};$street.bind("focus input keyup address-is-not-found address-select",check);$house.bind("focus input keyup",check)}}}}this.bindAddressHint=function(params,nobind){params=(!utils.isset(params)||!utils.isObject(params))?{}:params;if(utils.isBoolean(nobind)&&nobind==true){return}if(addressHintIsBound){return}if(validatorFilter.isAffected){bindAddressHint(params)}else{$(window).one("filters-is-affected",function(){bindAddressHint(params)})}};this.addressIsSelected=function(){var addrInfo=_this.address_process();if(utils.isEmpty(addrInfo.streetId)){return false}if($.inArray(_this.regionId,_this.tech_region_without_house)==-1&&utils.isEmpty(addrInfo.houseId)){return false}return true};this.isRequiredAddress=function(){return true};this.check_reset=utils.noop;this.check_complete=utils.noop;this.bindButtonSendToggle=function(){var $form=$(this.street.selector).parents(".validate_form");var $send=$(this.street.selector).parents(".validate_form").find(".filter-submit");for(var i in _this.regions_with_required_address){var item=_this.regions_with_required_address[i];if(item.klCode1&&utils.inArray(_this.getCityCode(),item.klCode1)){_this.check_reset=function(){$send.addClass("button-disabled").prop("disabled",true)};_this.check_complete=function(){$send.removeClass("button-disabled").prop("disabled",false)};$form.each(function(){var $fields=$(this).find([_this.street.selector,_this.house.selector,_this.flat.selector].join(","));$fields.bind("input",function(){if($fields.filter(function(){return !utils.isEmpty($(this).val())}).size()==$fields.size()){_this.check_complete()}else{_this.check_reset()}})});_this.check_reset();$(window).on("affect-filters",function(){_this.check_reset()});break}}};return this}})();