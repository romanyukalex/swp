(function(){SendSms=function(){this.clearSMSForm=function(){$("#captcha_sms").prop("src","//www."+docContext.properties.shortUrl+"/captcha.png?rnd"+Math.random());utils.buttonUnLoader($("#p-send-sms__submit_btn")[0].id);$("#send").remove();$(".p-send-sms__submit-load").show();$(".button-3").show();$("#p-send-sms__input-number").val("").validatorFilter("reinit");$("#p-send-sms__textarea-message").val("").validatorFilter("reinit");$("#sms__input-captcha").val("").validatorFilter("reinit");$(".p-send-sms__reload-captcha-img").click();$("#message_sms").text("");$("#p-send-sms__delaymassage-select1 [value='"+hourNow+"']").attr("selected","selected");$("#p-send-sms__delaymassage-select2 [value='"+minutesNow+"']").attr("selected","selected");$("#p-send-sms__delaymassage-select3 :first").attr("selected");$("select").selectric("refresh");$(".p-send-sms__delaymassage-wrap").attr("class").replace("_vis","_hid");$(".p-send-sms__respond").html("");$(".p-send-sms__textarea-limit").text("300")};this.checkAndSubmit=function(){var errors="";var currentRequest={};currentRequest.phone_number=$("#p-send-sms__input-number").val();var phone=currentRequest.phone_number;if(phone.indexOf("+")==0){phone=phone.substring(1)}if(phone.length==10){phone="7"+phone}currentRequest.phone_number=phone;currentRequest.message_text=$("#p-send-sms__textarea-message").val();currentRequest.captcha=$("#sms__input-captcha").val();currentRequest.message_text_trans="";currentRequest.delay_time="";currentRequest.delay_send="";currentRequest.region_id=window.adrMgr.selectedRegion.id;if($("#p-send-sms__delaymassage-input").is(":checked")){currentRequest.delay_send="1";var d_date=new Date();var n_date=new Date();d_date.setHours($("#p-send-sms__delaymassage-select1 :selected").val());d_date.setMinutes($("#p-send-sms__delaymassage-select2 :selected").val());d_date.setDate($("#p-send-sms__delaymassage-select3 :selected").data("day"));d_date.setMonth($("#p-send-sms__delaymassage-select3 :selected").data("month"));var delta=d_date.getTime()-n_date.getTime()-((180+d_date.getTimezoneOffset())*60*1000);if(delta>10*24*3600000){errors+="Отложить отправку SMS можно максимум на 10 дней."}else{if(delta<0){errors+="Указанные дата и время меньше текущих."}else{currentRequest.delay_time=delta}}}var d_date=new Date();currentRequest.offset_time=d_date.getTimezoneOffset();if(errors.length>0){$("#message_sms").html(errors).show();return}currentRequest.action="ins";currentRequest.mode="insSms";currentRequest.auto_trans="";currentRequest.page="";currentRequest.phone_number_list="";currentRequest.subsc_pwd="";if(!utils.buttonLoader($("#p-send-sms__submit_btn")[0].id)){return false}stat.gaqPageView("/send_sms_click");$("#message_sms").html("");var _this=this;$("#message_sms").show();$.ajax({url:"/ajax/sms/send",type:"post",dataType:"json",data:currentRequest,async:true,cache:false,success:function(resp){utils.buttonUnLoader($("#p-send-sms__submit_btn")[0].id);$("#captcha_sms").prop("src","//www."+docContext.properties.shortUrl+"/captcha.png?rnd"+Math.random());var res=resp.result;var msg="";if(!res||res.length<=0){res=resp.isError;msg=resp.errorMsg}_this.setCallMeResult(res,msg)}})};this.setCallMeResult=function(data,msg){if(data=="0"){stat.gaqPageView("/send_sms_done");stat.setYaCounter("send_sms");this.clearSMSForm();this.createPopup("Отправка SMS","Сообщение принято к отправке.")}else{var errMsgDic={"1":"Неверно указан код с картинки.","2":"Номер телефона указан в неверном формате.","3":"Сообщение не может быть отправлено на указанный номер.","4":"Сообщение не принято к отправке.","5":"Сообщение не может быть отправлено на указанный номер.","6":"Отправка сообщения невозможна. Абонент заблокировал прием SMS сообщений через WEB-сервис. ","7":"Отправка SMS-сообщений возможна только абонентам мобильной связи Ростелеком. ","8":"Сообщение не содержит текст. "};var errMsg=errMsgDic[data];if(!!msg){errMsg=msg}if(!errMsg){errMsg="Сообщение не может быть отправлено на указанный номер."}if(data==1){$("#sms__input-captcha").addClass("input-error")}$("#message_sms").text(errMsg);$("#message_sms").show();$(".p-send-sms__submit").show()}};this.init=function(){var _this=this;var textareaMessage_id="p-send-sms__textarea-message",textareaLimit_class="p-send-sms__textarea-limit",delaymassageSwitcher_id="p-send-sms__delaymassage-input",delaymassageWrap_class="p-send-sms__delaymassage-wrap";$(".p-send-sms__close").on("click",function(){_this.clearSMSForm();$.magnificPopup.close()});var textareaMessage=$("#"+textareaMessage_id),textareaLimit=$("."+textareaLimit_class),textareaLimit_max=+textareaLimit.text();textareaMessage.on("change keyup",function(){var curentVal=$(this).val(),curentLength=curentVal.length,curentLimit=textareaLimit_max-curentLength;if(curentLimit<=0){$(this).val(curentVal.slice(0,textareaLimit_max));curentLimit=0}textareaLimit.text(curentLimit)});$("#captcha_reload_sms").on("click",function(){$("#captcha_sms").prop("src","//www."+docContext.properties.shortUrl+"/captcha.png?rnd"+Math.random())});$("#captcha_sms").prop("src","//www."+docContext.properties.shortUrl+"/captcha.png?rnd"+Math.random());var delaymassageSwitcher=$("#"+delaymassageSwitcher_id),delaymassageWrap=$("."+delaymassageWrap_class);delaymassageSwitcher.on("ifChecked",function(event){delaymassageWrap.toggleClass(delaymassageWrap_class+"_vis "+delaymassageWrap_class+"_hid")});delaymassageSwitcher.on("ifUnchecked",function(event){delaymassageWrap.toggleClass(delaymassageWrap_class+"_vis "+delaymassageWrap_class+"_hid")});$(".p-send-sms__submit").click(function(){_this.checkAndSubmit();return false})};this.createPopup=function(title,body){this.clearSMSForm();$.magnificPopup.close();utils.Notice(body,title)}}})();