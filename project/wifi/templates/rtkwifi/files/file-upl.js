$(function oneFileUploadInit(){var FileUpload_StateDrop="file-upload_hover-drop",FileUpload_StateLoader="file-upload_loader",FileUpload_StateComplete="file-upload_complete",FileUpload_StateNoFocus="file-upload_no-focus",FileUpload_StateError="file-upload_error",defSize=716800;if(!window.fileCnt){window.fileCnt=0}if(!window.fileSize){window.fileSize=0}function generateBlock(){var _html='<div class="file-upload file-upload__wrap file-upload_related"><div class="file-upload__stop file-upload__stop_inset"></div><div class="file-upload__dropZone"><div class="file-upload__progress"></div><div class="file-upload__info-in">Прикрепить еще файл</div><input type="hidden" name="p-feedback__upload" value="1"/><input name="p-feedback__filepath" type="file" class="file-upload__input" data-size="716800"></div></div>';return _html}$($(".file-upload")[window.fileCnt]).each(function(i){var $ThisFileUpload=$(this),$DropZone=$ThisFileUpload.find(".file-upload__dropZone").eq(0),$InputFile=$ThisFileUpload.find(".file-upload__input").eq(0),$Progress=$ThisFileUpload.find(".file-upload__progress").eq(0),$InfoIn=$ThisFileUpload.find(".file-upload__info-in").eq(0),$StopUpload=$ThisFileUpload.find(".file-upload__stop").eq(0),$Desc=$ThisFileUpload.find(".file-upload__desc").eq(0),$ActiveElems=$DropZone.add($StopUpload),DefaultClasses=$ThisFileUpload.attr("class")+" ",abort=false;$InfoIn.data("defText",$InfoIn.text());$Desc.data("defText",$Desc.text());$InputFile.fileupload({dataType:"json",url:"/ajax/fileUploadRedis",dropZone:$DropZone,progressInterval:70,maxFileSize:$InputFile.data("size")||defSize,maxNumberOfFiles:1,singleFileUploads:true}).on("fileuploaddragover",function(e){$ThisFileUpload.attr("class",DefaultClasses+FileUpload_StateDrop)}).on("fileuploadadd",function(e,data){if(data.files[0].size>($InputFile.data("size")||defSize)){e.preventDefault();utils.Notice("Превышен размер файла","Ошибка");return}var file=data.files[0].name;var ext=file.split(".");if($ThisFileUpload.data("openWindowSelectFile")){utils.log("openWindowSelectFile");$ThisFileUpload.addClass(FileUpload_StateNoFocus);DefaultClasses+=FileUpload_StateNoFocus+" ";$(window).mousemove(function(){$ThisFileUpload.removeClass(FileUpload_StateNoFocus);var pos=DefaultClasses.indexOf(FileUpload_StateNoFocus),str1=DefaultClasses.substr(0,pos),str2=DefaultClasses.substr(pos+FileUpload_StateNoFocus.length+1);DefaultClasses=str1+str2;$ThisFileUpload.removeData("openWindowSelectFile");$(window).unbind("mousemove")})}$ActiveElems.off("mouseenter mouseleave");$InfoIn.text(data.files[0].name).data("CurentText","Прервать загрузку файла");$ThisFileUpload.attr("class",DefaultClasses+FileUpload_StateLoader);$(".file-upload__desc").data("filesize",(data.files[0].size/1024).toFixed()).text("загружается ("+$(".file-upload__desc").data("filesize")+" КБ)");$ActiveElems.on("mouseenter",function(){$ThisFileUpload.addClass(FileUpload_StateDrop);$InfoIn.data("prevText",$InfoIn.text());$InfoIn.text($InfoIn.data("CurentText"))}).on("mouseleave",function(){$InfoIn.text($InfoIn.data("prevText"));$ThisFileUpload.removeClass(FileUpload_StateDrop)}).on("click",function(){abort=true;data.abort();var params={};params.destroy=1;params.files=$InputFile.data("finame");$.ajax({url:"/ajax/fileUploadRedis",type:"post",dataType:"json",data:params,async:true,cache:false,success:function(resp){if(resp){if(window.fileCnt>0){window.fileCnt--;if(!!$InputFile.data("fisize")){window.fileSize-=$InputFile.data("fisize")}}if(!!window.docContext.callback_files){var r=window.docContext.callback_files.indexOf($InputFile.data("finame"));window.docContext.callback_files.splice(r,1)}$InputFile.fileupload().fileupload("destroy");$Progress.width(0);if(window.fileCnt==0){$(".file-upload__info-in").parent().parent().not(".permanent").remove();$(".file-upload__desc").text("(необязательно, файл не более 700 Кб)");$(".file-upload__info-in").text("Прикрепить файл")}else{$InfoIn.parent().parent().remove();$(".file-upload_complete").first().addClass("permanent");switch(window.fileCnt){case 1:$(".file-upload__desc").text("загружен "+window.fileCnt+" файл ("+(window.fileSize/1024).toFixed()+" Кб)");break;case 2:case 3:case 4:$(".file-upload__desc").text("загружено "+window.fileCnt+" файла ("+(window.fileSize/1024).toFixed()+" Кб)");break;case 5:$(".file-upload__desc").text("загружено "+window.fileCnt+" файлов ("+(window.fileSize/1024).toFixed()+" Кб)");break}if($(".file-upload_complete").length<5&&$(".file-upload").not(".file-upload_complete").length==0){$("#files_block").append(generateBlock());oneFileUploadInit()}}$ThisFileUpload.attr("class",DefaultClasses);if($(".file-upload").length==1){$ThisFileUpload.addClass("permanent")}$DropZone.add($StopUpload).off("mouseenter mouseleave click")}}})})}).on("fileuploadprogress",function(e,data){$Progress.width(data.loaded/data.total*100+"%")}).on("fileuploaddone",function(e,data){if(typeof data.result!=undefined){if(!window.docContext.callback_files){window.docContext.callback_files=[]}window.docContext.callback_files.push(data.result.filename);$InputFile.data("finame",data.result.filename);$InputFile.data("fisize",data.total);window.fileSize+=data.total;$("#fileName").val(data.result.filename);switch(window.fileCnt){case 0:$(".file-upload__desc").text("загружен "+(window.fileCnt+1)+" файл ("+(window.fileSize/1024).toFixed()+" Кб)");break;case 1:case 2:case 3:$(".file-upload__desc").text("загружено "+(window.fileCnt+1)+" файла ("+(window.fileSize/1024).toFixed()+" Кб)");break;case 4:$(".file-upload__desc").text("загружено "+(window.fileCnt+1)+" файлов ("+(window.fileSize/1024).toFixed()+" Кб)");break}$InfoIn.data("CurentText","Удалить файл");$ThisFileUpload.attr("class",DefaultClasses+FileUpload_StateComplete);if(window.fileCnt<4&&($(".file-upload").length-1)<=window.fileCnt){$("#files_block").append(generateBlock());window.fileCnt++;oneFileUploadInit()}else{window.fileCnt++}}}).on("fileuploadfail",function(e,data){if(!abort){$(".file-upload__info-in").trigger("click");utils.Notice("Произошла ошибка при загрузке файла","Ошибка")}else{abort=false}}).on("click",function(){$(this).parent().trigger("click");$ThisFileUpload.data("openWindowSelectFile",true)})})});