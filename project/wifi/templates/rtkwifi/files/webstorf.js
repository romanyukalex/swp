(function(){window.WebstoreInit=function WebstoreInit(){var replayce_key=["qwertyuiop[]asdfghjkl;'\\zxcvbnm,./<>{}\":","йцукенгшщзхъфывапролджэ\\ячсмитьбю.БЮХЪЭЖ"];var _this=this;this.select_txt_arr=["Подключить","Подробнее"];this.initRegionChoice=function(){var location=$(".location-top"),mobile_location=$(".location");if(!location.length||!mobile_location.length){return false}var search=location.first().elem("inputsearch"),searchwrap=location.first().elem("searchwrap"),helpsearch=location.first().elem("helpsearch"),helptxt=location.first().elem("helptxt"),helplist=location.first().elem("helplist"),close=location.first().elem("close");window.searchInput=search;var buttonSearchDesctop=search.siblings(".location-top__searchbtn");var mobile_location=$(".location"),mobile_search=$("#mb_cities_search"),mobile_city_list_wrapper=$("#mobile_city_list"),mobile_search2=$("#mb_cities_search2");function create_list_cities(res){var html="";if(res!=null){if(res.length>0){var searchtxt=$("#location-top__inputsearch").val().toLowerCase();for(var el in res){html+='<li class="location-top__helplist-item"><a href="javascript:;" data-mpz="'+res[el].mpzCode+'" data-street="'+res[el].street+'" data-regcode="'+res[el].kladr+'" data-code="'+res[el].klcode+'" data-adrname="'+res[el].name+'"';if(res[el].kllvl){html+='data-lvl="'+res[el].kllvl+'" '}html+='><span class="location-top__locoverlap">';if(res[el].socr==="Г"||res[el].socr==="г"){html+="<b>"}var tmp=res[el].name.toLowerCase();var searchIdx=tmp.indexOf(searchtxt);var str1="";var str2="";var str3="";if(searchIdx>=0){str1=res[el].name.substring(0,searchIdx);str2=res[el].name.substring(searchIdx,searchIdx+searchtxt.length);str3=res[el].name.substring(searchIdx+searchtxt.length);html+=str1;html+="<span class='location-top__letteroverlap'>"+str2+"</span>";html+=str3}else{html+=res[el].name}if(res[el].socr==="Г"||res[el].socr==="г"){html+="</b>"}html+="</span>";var cName=window.adrMgr.regions[res[el].kladr].name;html+='<span class="loc-plaintxt">';html+=" ("+res[el].socr+"), "+(res[el].addName!=cName?res[el].addName+" ":"")+cName;html+="</span>";html+="</a>";html+="</li>"}}}return html}helpsearch.mouseenter(function(){$(this).data("mousein",true)});helpsearch.mouseleave(function(){$(this).data("mousein",false)});var index=-1;var is_result=false;var count=0;search.keypress(function(e){if(e.which==13){if(index>-1){helplist.find("li").eq(index).trigger("click")}}});search.keyup(function(e){if(is_result&&count>0){var changed=false;if(e.which==38){index=Math.max(index-1,0);changed=true}else{if(e.which==40){index=Math.min(index+1,count-1);changed=true}}if(changed){var curLi=helplist.find("li").removeClass("location-top__helplist-item_active").eq(index).addClass("location-top__helplist-item_active");var docViewTop=helplist.scrollTop();var docViewBottom=docViewTop+helplist.height();var elemTop=curLi.offset().top;var elemBottom=elemTop+curLi.height();var fullHeight=helplist.height()+curLi.height()+search.height();var fullTop=elemTop-curLi.height()-search.height();if(fullHeight<elemTop){helplist.scrollTop(docViewBottom)}if(fullTop<0){helplist.scrollTop(docViewTop-helplist.height())}}}});var lastName="";var en_reg=/(\s+)?([а-яА-Я]+)?([a-zA-Z <>,\.\[\]\{\}\'\:\;\"]+)?/gi;var en_char=/[a-zA-Z]/gi;var replaceEnChar=function(ch){for(var i=0;i<replayce_key[0].length;i++){if(ch===replayce_key[0][i]){return replayce_key[1][i]}}return ch};var old_en_string_input="";var sendSearch=function(noScipMode){helptxt.html("<i class='spinner-circle-blue spinner-circle-blue_inline-block'></i> Пожалуйста, подождите.");var enString=search.val().toLowerCase();var newString="";if(lastName===search.val()&&!noScipMode){return}lastName=search.val();for(var i=0;i<enString.length;i++){newString=newString+replaceEnChar(enString[i])}lastName=newString;$.ajax({url:window.docContext.properties.searchUrl+"ajax/search_city",type:"post",dataType:"jsonp",async:true,cache:false,data:{query:lastName,kladr:adrMgr.selectedRegion.klRegion},success:function(json){var res=json.result;is_result=true;index=-1;if(res){count=res.length;if(res.length>0){$(".location-top__helplist").html(create_list_cities(res));$(".location-top__helplist-item").click(function(e){e.preventDefault();var __change_city=function(){utils.sendPostWithUserCollector(window.location.pathname.replace("/"+adrMgr.selectedCity.synonym,""),{addr_code:$this.data("code"),addr_lvl:$this.data("lvl"),addr_reg:$this.data("regcode"),addr_name:$this.data("adrname"),addr_street:$this.data("street"),addr_mpz_code:$this.data("mpz")})};var $this=$(this).find("a").first();stat.fixStat("change_city");if(ie_ver()){var regSynonym=window.adrMgr.regions[$this.data("regcode")];if(!regSynonym||!regSynonym.synonym){utils.setIECookie(regSynonym.synonym,__change_city)}else{__change_city()}}else{__change_city()}});helptxt.delMod("state");helplist.mod("state","on")}else{helptxt.text("К сожалению, такого населенного пункта в списке нет");helptxt.mod("state","on");helplist.delMod("state")}}else{helptxt.text("К сожалению, такого населенного пункта в списке нет");helptxt.mod("state","on");helplist.delMod("state")}},error:function(e){utils.log(e.arguments)}})};function your_func(){return{}}window.buttonsa=buttonSearchDesctop;buttonSearchDesctop.on({click:function(){searchwrap.mod("state","focus");helpsearch.mod("state","on");if(checkVal(search,true)){helptxt.delMod("state");helplist.mod("state","on")}else{helptxt.text("Пожалуйста, введите название своего населенного пункта");helptxt.mod("state","on");helplist.delMod("state")}}});search.on({blur:function(){if(!helpsearch.data("mousein")){searchwrap.delMod("state");helpsearch.delMod("state")}},focus:function(){searchwrap.mod("state","focus");helpsearch.mod("state","on");if(checkVal($(this))){helptxt.delMod("state");helplist.mod("state","on")}else{helptxt.text("Пожалуйста, введите название своего населенного пункта");helptxt.mod("state","on");helplist.delMod("state")}},keyup:function(e){var b=/[-а-яА-Я\s]/;var eng=/[a-zA-Z <>,\.\[\]\{\}\'\:\;\"]/;if(e.which==40||e.which==38){return}if(search.sendSearchTimer){clearTimeout(search.sendSearchTimer);search.sendSearchTimer=null}if(checkVal($(this))&&b.test($(this).val())||eng.test($(this).val())){if(!search.sendSearchTimer){search.sendSearchTimer=setTimeout(sendSearch,1000)}}else{helptxt.text("Пожалуйста, введите название своего населенного пункта");helptxt.mod("state","on");helplist.delMod("state")}}});function checkVal(el,noCheck){if(el.is(":focus")||noCheck){var val=el.val();if(val.length){return true}else{return false}}}function create_mobile_list_cities(res){var html="";for(var el in res){html+='<li><a href="javascript:;" data-mpz="'+res[el].mpzCode+'" data-street="'+res[el].street+'" data-regcode="'+res[el].kladr+'" data-code="'+res[el].klcode+'"" data-adrname="'+res[el].name+'"';if(res[el].kllvl){html+='data-lvl="'+res[el].kllvl+'"'}var cName=window.adrMgr.regions[res[el].kladr].name;html+=">"+res[el].name+" ("+res[el].socr+"), "+(res[el].addName!=cName?res[el].addName+" ":"")+cName+"</a></li>"}return html}var mobileSendSearch=function(fake){var lastSend=(fake?mobile_search2.data("lastsend"):mobile_search.data("lastsend"));if(!lastSend){lastSend=1}var enString=(fake?mobile_search2.val():mobile_search.val()).toLowerCase();var en_string="";var result_str=fake?mobile_search2.val():mobile_search.val();if(en_reg.test(enString)){for(var i=0;i<enString.length;i++){en_string=en_string+replaceEnChar(enString[i])}result_str=en_string}$.ajax({url:window.docContext.properties.searchUrl+"ajax/search_city",type:"post",dataType:"jsonp",async:true,cache:false,data:{query:result_str,kladr:fake?adrMgr.selectedRegion.klRegion:mobile_city_list_wrapper.attr("reg")},success:function(json){var res=json.result;var mobile_cities_list=$(".location__cities-list");if(fake){$(".location__regions-list").hide()}if(res&&res.length>0){mobile_cities_list.html(create_mobile_list_cities(res));mobile_cities_list.find("a").click(function(e){e.preventDefault();var $this=$(this);utils.sendPostWithUserCollector(window.location.pathname.replace("/"+adrMgr.selectedCity.synonym,""),{addr_code:$this.data("code"),addr_lvl:$this.data("lvl"),addr_reg:$this.data("regcode"),addr_name:$this.data("adrname"),addr_street:$this.data("street"),addr_mpz_code:$this.data("mpz")})})}else{mobile_cities_list.html('<li><a href="javascript:;">К сожалению, такого населенного <br> пункта в списке нет</a></li>')}},error:function(e){utils.log(e)}})};$(".location__search-input").on({keyup:function(){var b=/^([\s |a-zA-Zа-яА-я<>,\.\[\]\{\}\'\:\;\"]+)/gi;$this=$(this);var name_input=($this.data("fake")?mobile_search2:mobile_search);if(name_input.sendSearchTimer){clearTimeout(name_input.sendSearchTimer);name_input.sendSearchTimer=null}if($this.val().trim()==""){if(!$this.data("fake")){adrMgr.render(mobile_city_list_wrapper.attr("reg"))}else{$(".location__regions-list").show()}}else{if(!b.test($this.val())){$(".location__cities-list").html("")}else{if(checkVal($this)){if(!name_input.sendSearchTimer){name_input.sendSearchTimer=setTimeout(mobileSendSearch($this.data("fake")),1000)}}}}}});$(".location-expd").elem("search").on("click",function(){$.smoothScroll({afterScroll:function(){search.focus()}})});$(".location-list").elem("link").on("click",function(){$(this).block().elem("link").delMod("state","act");$(this).mod("state","act")})};this.loadCss=function(url){var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=url;document.getElementsByTagName("head")[0].appendChild(link)};this.initOptionsv01=function(){utils.log(arguments.callee)};var hashForDefaultRedirect=null;this.initAuth=function(){var elkAuth={};elkAuth.sendLogin=function(redirect){$("#elkAuthErr").hide();var $button=$("#auth-submit"),btnText=$button.text();if(!utils.buttonLoader($button.attr("id"))){return false}$.ajax({url:("https://")+location.host+"/ajax/elk/auth",type:"post",dataType:"jsonp",async:true,cache:false,data:{login:$("#elkLogin").val(),passwd:$("#elkPasswd").val(),rememberMy:$("#elkRememberMy").is(":checked")},success:function(resp){var data=resp.result;if(data&&data.auth&&data.sessionHashKey){document.cookie="scheme=https";$.ajax({url:elkUrl+"/sc.jsp?sessionHashKey="+data.sessionHashKey,type:"get",crossDomain:true,dataType:"jsonp",complete:function(){var protocol="https:";location.href=redirect?redirect:(protocol+"//"+location.host+location.pathname+(hashForDefaultRedirect||""));if(location.protocol==protocol){location.reload()}}})}else{$("#elkAuthErr").show()}},error:function(e){utils.log(arguments)},complete:function(){utils.buttonUnLoader($button.attr("id"),btnText)}})};elkAuth.logout=function(){$.ajax({url:"/ajax/elk/logout",type:"post",dataType:"json",async:true,cache:false,success:function(resp){if(resp.result){location.reload()}}})};elkAuth.getServiceTypeName=function(type){if(type==="INTERNET"){return"Домашний интернет"}if(type==="TELEPHONY"){return"Домашний телефон"}if(type==="GSM"){return"Мобильная связь"}if(type==="WIFI"){return"Wi-Fi"}if(type==="CDMA"){return"Мобильный телефон CDMA"}if(type==="SECURITY"){return"Безопасный дом"}if(type==="IPTV"){return"Интерактивное ТВ"}if(type==="VPBX"){return"Облачная АТС"}if(type==="SKYLINK"){return"Мобильная связь Skylink"}};elkAuth.isSouth=function(regCode){return utils.inArray(regCode,["01","05","07","08","09","15","23","26","30","34","61","06","20"])};elkAuth.loadAccouns=function(){if($("#authorized-user-short:visible").size()==0){return false}$.ajax({url:"/ajax/elk/visibleAccounts",type:"post",dataType:"json",async:true,cache:false,success:function(resp){$("#btn_elk_href").hide();$("#fpl_balance").hide();if(resp.isError!=0){$("#authorized-user-short").find(".user-collection-box").first().html('<p class="user__important-text">Ошибка при загрузке лицевых счетов, повторите позднее</p>');return}var elkData=resp.result;if(elkData.resCode==1){$("#authorized-user-short").find(".user-collection-box").first().html('<p class="user__important-text">Пользовательская ссессия не активна, перезагрузитесь</p>');return}var html="";if(elkData.resCode==2){html+='<p class="user__lite-text">У вас нет присоединенных услуг</p>';html+='<a href="'+elkData.elkUrl+'" target="_blank" class="user__important-text">Добавить услугу</a>';$("#btn_elk_href").html('<a class="button-1 button-1_size-small button-1_width-100 user__btn" href="'+elkData.elkUrl+'" target="_blank">Перейти в Личный кабинет</a>');$("#authorized-user-short").find(".user-collection-box").first().html(html)}if(elkData.resCode==3){for(var accI=0;accI<elkData.accounts.length;accI++){var account=elkData.accounts[accI];if(account.region&&elkAuth.isSouth(account.region)){html+='<p class="user__lite-text">Номер договора № '+account.displayNumber+"</p>"}else{html+='<p class="user__lite-text">Лицевой счет № '+account.displayNumber+"</p>"}for(var srvI=0;srvI<account.services.length;srvI++){var service=account.services[srvI];var aliase=service.aliase;if(!aliase){aliase=elkAuth.getServiceTypeName(service.serviceType)}html+='<p href="'+elkData.elkUrl+"#service?id="+service.id+'" target="_blank" class="user__important-text">'+aliase+": "+service.displayNumber+"</p>"}if(account.balance){var accKop=Math.abs(account.balance%100);var accRub=parseInt(account.balance/100);var accStr=accRub+",";if(accKop<10){accStr=accStr+"0"}accStr=accStr+accKop;if(account.balance>0){html+='<p class="user__important-text">'+accStr+" руб.</p>"}else{html+='<p class="user__important-text">'+accStr+" руб.</p>"}}else{html+='<p class="user__important-text">нет данных</p>'}if(accI===elkData.accounts.length-1){$("#btn_elk_href").html('<a class="button-1 button-1_size-small button-1_width-100 user__btn" href="'+elkData.elkUrl+'">Пополнить баланс</a>').show()}}$("#authorized-user-short").find(".user-collection-box").first().html(html)}if(elkData.resCode==4){html+='<p class="user__lite-text">В вашем личном кабинете</p>';html+='<p href="'+elkData.elkUrl+'" target="_blank" class="user__important-text">'+elkData.serviceCount+" услуг на "+elkData.accountCount+" лицевых счетах</p>";$("#btn_elk_href").html('<a class="button-1 button-1_size-small button-1_width-100 user__btn" href="'+elkData.elkUrl+'" target="_blank">Перейти в Личный кабинет</a>').show();$("#authorized-user-short").find(".user-collection-box").first().html(html)}if(elkData.fplBalance){html='<p class="user__lite-text">Программа «БОНУС»</p>';html+='<p class="user__important-text">Бонусный баланс: '+elkData.fplBalance+"</p>";$("#fpl_balance").html(html).show()}},error:function(e){utils.log(arguments)}})};function onSubmitAuth(){elkAuth.sendLogin($(this).data("redirect"))}$("#auth-submit").click(onSubmitAuth);$("#elklogout").click(elkAuth.logout);$("a.user-login__link_auth-true").click(elkAuth.loadAccouns);$("#elkPasswd").keypress(function(e){if(e.which==13||e.keyCode==13){e.preventDefault();$("#auth-submit").click()}});if(docContext.isAuth){$(".js-custom-user-login__link").on("click",function(e){location.href=$(this).data("redirect")})}else{$(".js-custom-user-login__link").each(function(e){var $link=$(this),$form=$($link.attr("href")),$submit=$form.find(".js-submit-auth");$link.magnificPopup({items:{src:$form},type:"inline",closeBtnInside:false,showCloseBtn:false,fixedContentPos:false,callbacks:{beforeOpen:function(){$submit.data("redirect",$link.data("redirect"))},afterClose:function(){$submit.removeData("redirect")}}})})}if($("#swf-phone").length){var $phone=$("#phone");setFlashHeight=function(newHeight){$phone.css("height",newHeight)};$('[href="#swf-phone"]').click(function(){$phone.css("height",$phone.attr("height"))})}if($("#webconferrence").length){$("#auth-submit").click(function(){var $submit=$(this),$form=$submit.closest(".validate_form");if(!utils.buttonLoader($submit.attr("id"))){return}var $remember=$form.find(".js-videoconf-remember");utils.sendPost($submit.data("redirect-url"),{login:$form.find(".js-videoconf-login").val(),password:$form.find(".js-videoconf-password").val(),remember_auth:$remember.prop("checked")?$remember.val():""})})}var name_title={standart:"Номер",personal_score:"Номер лицевого счета",tkt:"Номер договора",login:"Логин"};var login_title_mass=[{title:name_title.personal_score,regexp:/.+nw.+BILL(.+)?/gi,name:"value"},{title:name_title.standart,regexp:/^MTF_CONTRACT_NUM$/gi,name:"alterId"},{title:name_title.personal_score,regexp:/^DTK$/gi,name:"alterId"},{title:name_title.tkt,regexp:/^(.+)?\.TKT\.(.+)?$/gi,name:"value"},{title:name_title.login,regexp:/^KABINET$/gi,name:"alterId"}];function getLoginTitle(option_select_data_type){for(var i=0;i<login_title_mass.length;i++){var current_title=login_title_mass[i];var dataName=option_select_data_type[current_title.name];if(dataName){if(!!dataName.match(current_title.regexp)){return login_title_mass[i].title}}}return name_title.standart}$("#fastpayment").each(function(){var $form=$(this);var payTypes=docContext.payTypes;if(!utils.isEmpty(payTypes)){var $types=$form.find("select.js-pay-on-main-type"),$number=$form.find(".js-pay-on-main-number"),$summa=$form.find(".js-pay-on-main-sum"),$subtypes=$form.find("select.js-pay-on-sub-type"),$invoice=$form.find(".js-invoice");$invoice.after('<p class="color-white f-12 gap_dt">3 знака без разделительных символов и ведущих нулей.</p>');for(var i in payTypes){var type=payTypes[i];$types.append($("<option>").data("type",type).attr("value",type.value||"default").text(type.title))}$types.selectric("refresh");$types.change(function(){var $type=$types.find("option:selected"),type=$type.data("type");var $name_number_lable=$("label.label-type2[for=pay-on-main-number]");$name_number_lable.text(getLoginTitle(type));$.fn.matchHeight._update();$number.validatorFilter("unbind");$number.attr("maxlength",type.maxSize||64);$number.attr("data-invalid-error",type.hint||"Без префиксов и разделительных символов.");$number.next().text(type.hint||"Без префиксов и разделительных символов.");$summa.next().text("не менее 1 руб. и не более 30000 руб.");var filters="";if(type.alterId=="PHONE"){if(utils.isEmpty(type.maxSize)){$number.attr("maxlength",11);filters="filter-phone"}else{if($.inArray(type.maxSize,[10,11])>-1){filters="filter-home-phone"}else{filters="filter-pay-account"}}}else{filters="filter-pay-account"}$number.validatorFilter("append",filters);$number.validatorFilter("bind");var mq_flag=1;if(!!mq()){mq_flag=mq()}if(type.alterId=="BILL"){$subtypes.validatorFilter("off");if($.inArray(mq_flag,[3,4])>-1){$subtypes.parent().hide()}else{$subtypes.parent().parent().parent().hide()}$invoice.validatorFilter("on").parent().show()}else{$invoice.validatorFilter("off").parent().hide();if(type.services.length>0){$subtypes.html($subtypes.find("option").first());for(var service in type.services){var service=type.services[service];$subtypes.append($("<option>").attr("value",service.value||"default").text(service.title))}$subtypes.selectric("refresh");$subtypes.validatorFilter("on");if($.inArray(mq_flag,[3,4])>-1){$subtypes.parent().show()}else{$subtypes.parent().parent().parent().show()}}else{$subtypes.validatorFilter("off");if($.inArray(mq_flag,[3,4])>-1){$subtypes.parent().hide()}else{$subtypes.parent().parent().parent().hide()}}}if($number.val().length>0){if($number.val().length>$number.attr("maxlength")){$number.val($number.val().substring(0,$number.attr("maxlength")))}$number.validatorFilter("validate");if($number.hasClass("input-error")){$number.focus()}}});$summa.parent().attr("original-title","Укажите сумму не менее 1 руб. и не более 30000 руб.").tipsy({delayIn:100,delayOut:100,offset:-6,gravity:"nw",opacity:1,trigger:"manual",className:"tipsy-attention"});$summa.bind("blur",function(){$summa.parent().tipsy("hide")});function validSumma(){var value=utils.toInt($summa.val());return value>=1&&value<=30000}$summa.bind("focus input keyup",function(e){if(e.type=="keyup"&&!validatorFilter.isChanging(e)){return}var isShow=false;if(!$summa.hasClass("input-error")&&$summa.val().trim().length>0){isShow=!validSumma()}$summa.parent().tipsy(isShow?"show":"hide")});$(".js-pay-on-main-send").attr("id",utils.unique()).click(function(){var $button=$(this),$form=$button.parents(".validate_form"),isCorrect=validatorFilter.validateForm($form);if(isCorrect&&!validSumma()){$summa.focus();isCorrect=false}if(isCorrect){var $accept=$("input.js-pay-on-main-accept");if(!$accept.is(":checked")){utils.Notice($accept.data("message"),"Внимание!");isCorrect=false}}if(isCorrect){try{stat.setYaCounter("payment_main_click");stat.gaqEvent("payment","payment_main_click")}catch(error){}var p={svc_type_alter_id:$types.find("option:selected").data("type").alterId,svc_type_id:($types.val()=="default"?"":$types.val()),svc_num:$number.val(),sum:$summa.val(),isSubmit:1,"new":true,inFrame:1,act:1};if($types.find("option:selected").data("type").services.length>0){p.svc_sub_num=($subtypes.val()=="default"?"":$subtypes.val())}else{if($types.find("option:selected").data("type").alterId=="BILL"){p.svc_sub_num=($invoice.val()=="default"?"":$invoice.val())}}var params=$.param(p);var url=$button.data("url")||"/";window.location.href="//www."+docContext.properties.shortUrl+$button.data("url")+(url.indexOf("?")==-1?"?":"&")+params}})}})};actions.siteSecondNavInit();actions.showPromoBlock();actions.offerSVGTriangle();var needInitICheck=false;this.Antiviruses=function($this){needInitICheck=true;var self={};self.requestOrderUrl=function(serviceId,serviceNumber,antivirusId,email,callback){if(!callback){return}if(utils.isEmpty(serviceId)){callback()}else{$.ajax({url:"/ajax/getAntivirusOrderUrl",type:"post",dataType:"json",async:true,cache:false,data:{serviceId:serviceId,serviceNumber:serviceNumber,antivirusId:antivirusId,email:email},success:function(response){if(response.isError==0){callback(response.url)}else{callback()}},error:function(e){utils.log(e);callback()}})}};self.services=null;self.requestServices=function(callback){if(!callback){return}if(self.services){callback(self.services);return}$.ajax({url:"/ajax/elk/getShpdServices",type:"post",dataType:"json",async:true,cache:false,success:function(response){if(response.isError==0){self.services=response.services;callback(self.services)}else{callback()}},error:function(e){utils.log(e);callback()}})};self.buildService=function($item,service){$item.text((utils.isEmpty(service.aliase)?"Домашний интернет":service.aliase)+": "+service.displayNumber).data("id",service.id).data("number",service.displayNumber)};var $section=$this.find("#antiviruses-with-popups, .js-antiviruses-with-popups"),$elkLink=$this.find("#elk-link-for-antiviruses, .js-elk-link-for-antiviruses"),$antiviruses=$section.find(".js-antivirus"),$frameLink=$section.find(".js-order-frame");self.updateElkLink=function(serviceId){var elkHref=$elkLink.attr("href")||"";elkHref=elkHref.replace(/#.*/,"");if(serviceId){elkHref+="#service?id="+serviceId}$elkLink.attr("href",elkHref)};function getId($antivirus){var id=$antivirus.data("id");if(!utils.isNumber(id)){var $radios=$antivirus.find('input[type="radio"]');id=utils.toInt(id.split(",")[$radios.index($radios.filter(":checked"))])}return id}var classes=["cost-rubmonth-2rows","cost-rubyear-2rows"];function getFee($antivirus){var fee=$antivirus.find(".js-fee").text();var $fee=$();if(utils.isEmpty(fee)){var $radios=$antivirus.find('input[type="radio"]');$fee=$antivirus.find($.map(classes,function(c){return"."+c}).join(",")).eq($radios.index($radios.filter(":checked")));fee=$fee.text()}var filtredClasses=[];for(var i in classes){if($fee.hasClass(classes[i])){filtredClasses.push(classes[i])}}return{value:fee,classes:filtredClasses.length>0?filtredClasses.join(" "):"cost-rubmonth-2rows"}}if($antiviruses.has(".js-connect").size()==0){$antiviruses.find(".js-open-popup").addClass("js-connect")}if(!docContext.isAuth){$antiviruses.each(function(){var $antivirus=$(this);$antivirus.find(".js-connect").click(function(){hashForDefaultRedirect="#antivirus="+getId($antivirus);$('.user-login__link[href="#modal-login"]').click()})});var params=utils.deparam(location.hash.slice(1));if(params){delete params.antivirus;location.hash="#"+$.param(params)}}else{var $openedPopup=$.magnificPopup.instance.currItem?$($.magnificPopup.instance.currItem.src):null;$antiviruses.each(function(){var $antivirus=$(this),$connect=$antivirus.find(".js-connect"),popupHref=$connect.attr("href"),$popup=!utils.isEmpty(popupHref)?$(popupHref):$(),$content=$popup.find(".js-content"),$accept=$popup.find(".js-accept"),$submit=$popup.find(".js-submit"),$monoService=$popup.find(".js-mono-service"),$services=$popup.find(".js-services"),$loader=$popup.find(".js-loader"),$empty=$popup.find(".js-empty"),$email=$popup.find('[name="email"]'),$price=$popup.find(".js-price").filter(function(){return $(this).closest(".js-description").size()==0});$submit.data("text",$submit.text());var resetIframe=function(){$popup.css("max-width","");$content.css("max-width","");utils.buttonUnLoader($submit.attr("id"),$submit.data("text"));$popup.data("is-reopen",true);$popup.find(".js-frame").remove();$content.children().show()};$connect.click(function(){resetIframe();var $description=$popup.find('.js-description[data-antivirus-id="'+getId($antivirus)+'"]');$popup.find(".js-description").hide();$description.show();$popup.find(".js-price").hide();var fee=getFee($antivirus);$price.find(".js-fee").text(fee.value).attr("class","js-fee").addClass(fee.classes);$price.toggle($description.find(".js-price").show().size()==0);$monoService.hide().removeClass("js-active");$services.hide().removeClass("js-active");$empty.hide();$loader.show();$submit.prop("disabled",true).addClass("button-disabled");if(utils.isEmpty($email.val())){$email.val($.trim($(".user__mail").text()))}self.requestServices(function(services){$loader.hide();$services.find("select").validatorFilter("off");if(services&&services.length>0){if(services.length==1){self.buildService($monoService,services[0]);$monoService.addClass("js-active").show()}else{var $select=$services.find("select");$select.find("option").filter(function(){return !utils.isEmpty($(this).data("id"))}).remove();utils.resetSelectric($select);for(var i in services){var service=services[i];var $option=$("<option>").attr("value",service.id);self.buildService($option,service);$select.append($option)}$select.selectric("refresh");$services.addClass("js-active").show();$services.find("select").validatorFilter("on")}$submit.prop("disabled",false).removeClass("button-disabled")}else{$empty.show()}});$submit.unbind("click.antivirus").bind("click.antivirus",function(){if(!$accept.is(":checked")){utils.Notice("Необходимо принять условия пользовательского соглашения","Внимание")}else{if(!utils.buttonLoader($submit.attr("id"))){return false}var $service=$monoService.is(".js-active")?$monoService:$services.find("select").find("option:selected");self.updateElkLink($service.data("id"));self.requestOrderUrl($service.data("id"),$service.data("number"),getId($antivirus),$email.val(),function(url){if(utils.isEmpty(url)){utils.buttonUnLoader($submit.attr("id"),$submit.data("text"));utils.Error("Сервис временно не доступен","Внимание")}else{if($frameLink.size()>0&&!utils.isEmpty($frameLink.attr("href"))){$($frameLink.attr("href")).attr("href",url);$frameLink.trigger("click")}else{var $iframe=$("<iframe />").attr("src",url),$wrapper=$("<div>").addClass("mfp-iframe-scaler js-frame").append($iframe);$content.append($wrapper.hide());$popup.data("is-reopen",false);$iframe.one("load",function(){if(!$popup.data("is-reopen")){utils.buttonUnLoader($submit.attr("id"),$submit.data("text"));$content.children().not(".js-frame,.js-mfp-close").hide();var width=utils.toInt($content.data("iframe-width")),delta=$popup.width()-$content.width();if(width>0){$content.css("max-width",width);$popup.css("max-width",width+delta)}$wrapper.show()}});$iframe.one("error",function(){resetIframe();utils.Error("Сервис временно не доступен","Внимание")})}}})}})});if($popup.is($openedPopup)){$connect.click();$openedPopup=null}if(popupHref==location.hash){location.hash=""}});var params=utils.deparam(location.hash.slice(1));if(params){if(!utils.isEmpty(params.antivirus)){$antiviruses.filter(function(){var id=$(this).data("id");return utils.isNumber(id)&&id==params.antivirus||!utils.isNumber(id)&&(id||"").split(",").indexOf(params.antivirus)!=-1}).find(".js-connect").click();delete params.antivirus;location.hash="#"+$.param(params)}}}};$("#antiviruses, .js-antiviruses").each(function(){_this.Antiviruses($(this))});this.initFlatTariffPromotion=function($section){needInitICheck=true;if(!$section.length){return}var $tariffs=$section.find(".js-tariff[data-tag]");var address=adrMgr.other?adrMgr.other:adrMgr.selectedCity;$.ajax({url:"/ajax/tariffs/getPromoInfos",type:"post",data:{mpzCode:address.mpzCode,klRegion:address.klRegion,tags:$.map($tariffs,function(tariff){var $tariff=$(tariff);return $.map(($tariff.attr("data-tag")||$tariff.attr("data-tags")||"").split(","),function(tag){return utils.toInt(tag)})})},dataType:"json",async:true,cache:false,success:function(resp){if(resp.isError==0&&resp.result){for(var tag in resp.result){var info=resp.result[tag];var $tariff=$tariffs.filter(function(i,tariff){var $tariff=$(tariff);return $tariff.data("tag")==tag||$(($tariff.attr("data-tags")||"").split(",")).filter(function(j,subTag){return utils.toInt(subTag)==tag}).size()>0});$tariff.find(".js-fee").text(Math.round(info.fee/100));var $link=$tariff.find("a.js-link");$link.attr("href",utils.getLinkWithCity($link.attr("href")))}$tariffs.show();$section.show()}},error:function(e){utils.log(e)}})};$(".js-flat-tariff-promo").each(function(){_this.initFlatTariffPromotion($(this))});function checkFinishOfPromoTables(){var visibleSections=$(".js-tariff-table-promo:not(.js-is-hidden)");if(visibleSections.size()==1){visibleSections.removeClass("section-divider")}else{if(visibleSections.size()==0){$(".js-tariff-table-promo").parents(".p-section").hide();$(".p-section-header").find(".c-wrap").append($(".js-tariff-table-promo-empty").show())}}}this.initTariffPromoTable=function($section){needInitICheck=true;if(!$section.length){return}var $table=$section.find("table"),$loader=$section.find(".js-loader");var address=adrMgr.other?adrMgr.other:adrMgr.selectedCity;$.ajax({url:"/ajax/tariffs/getPromoSummaries",type:"post",data:{mpzCode:address.mpzCode,klRegion:address.klRegion,tags:$.map(($table.attr("data-tags")||"").split(","),function(tag){return utils.toInt(tag)}),techIds:$.map(($table.attr("data-techIds")||"").split(","),function(techId){return utils.toInt(techId)})},dataType:"json",async:true,cache:false,success:function(resp){if(resp.isError==0&&resp.result&&resp.result.length>0){var $heads=$table.find("th"),$body=$table.find("tbody");$.each(resp.result,function(i,summary){var $row=$("<tr>");$row.data("tariff-id",summary.id);$heads.each(function(){var $head=$(this);var value=summary[$head.data("field")]||$head.data("default-value")||"";var prefix=$head.data("prefix"),suffix=$head.data("suffix");var $inner=$("<span>");if(!utils.isEmpty(value)&&!utils.isEmpty(prefix)){$inner.append(prefix)}$inner.append($("<span>").text(value).addClass(!utils.isEmpty(value)?$head.data("wrap-class"):""));if(!utils.isEmpty(value)&&!utils.isEmpty(suffix)){$inner.append(suffix)}$row.append($("<td>").html($inner))});$body.append($row)});$loader.hide();checkFinishOfPromoTables()}else{$section.addClass("js-is-hidden").hide();checkFinishOfPromoTables()}},error:function(e){utils.log(e);$section.addClass("js-is-hidden").hide();checkFinishOfPromoTables()}})};$(".js-tariff-table-promo").each(function(){_this.initTariffPromoTable($(this))});$("a.js-link-without-city").each(function(){var $link=$(this);$link.attr("href",utils.getLinkWithCity($link.attr("href")))});this.bindTipsyUpdater=function($targets,normalGravity,smallGravity){function getGravity(){return $.inArray(mq(),[3,4])>-1?smallGravity:normalGravity}function update(){$targets.each(function(){var $target=$(this);try{var options=$target.data().tipsy.options;var gravity=getGravity();if(gravity){options.gravity=gravity}options.title=gravity==smallGravity||!utils.isset(gravity)?function(){try{var $tipsy=$target.data().tipsy.$tip,$inner=$tipsy.find(".tipsy-inner");if($tipsy.offset().left<0){$inner.css("max-width",utils.toInt($inner.css("max-width"))+$tipsy.offset().left)}}catch(error){}return $target.attr("data-tooltip")}:"data-tooltip";$target.tipsy("hide");$target.removeData("tipsy").tipsy(options)}catch(error){}})}$(window).resize(update);update();if(mq()==4){$targets.one("mouseover",function(){$(this).trigger("mouseover")})}};if(needInitICheck){actions.iCheckCheckboxGray();actions.iCheckCheckboxBlue();actions.iCheckRadioBlue();actions.iCheckRadioGrey()}$(window).on("load",function(){var $input=$("#cart-date_connect");$input.datepick("option","minDate",new Date(new Date().getTime()+1000*60*60*24));try{var renderer=$input.data().datepick.options.renderer;renderer.picker=renderer.picker.replace("{link:today}","")}catch(e){}});$(window).load(function(){$(".js-input-datepick.after100years").each(function(){$(this).datepick("option","minDate",new Date(1920,0,1)).datepick("option","maxDate","today").datepick("option","yearRange","-100:+0")})});return this}})();