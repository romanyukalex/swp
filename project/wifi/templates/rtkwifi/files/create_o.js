(function(){CreateOrder=function CreateOrder(){this.city;this.extMode=true;this.initSrvFilter="";this.stateCookie="create-order-state";this.previousState=null;this.formName=null;this.statGoal="fast_order";var regionsNeedsInAddress=["22","75","38","42","42","24","54","55","04","03","17","19","70","45","59","66","72","74","86","89","27","28","79","41","49","25","65","14","69","68","62","31","32","33","44","36","37","40","48","57","67","71","46","76","30","34","23","01","05","07","08","09","61","15","26","06","18","43","02","12","13","52","56","58","63","64","73","21","16","78","29","35","39","47","51","53","60","10","11","50"];this.isExtMode=function(){return this.extMode};this.isNeedInAddress=function(){return this.extMode||$.inArray(this.city.klRegion,regionsNeedsInAddress)>-1};this.init=function(){this.orderAPI=new OrderAPI(this.isExtMode()?107:0);this.previousState=utils.deparam($.cookie(this.stateCookie));$.cookie(this.stateCookie,"",{path:"/",domain:"."+domain});if(typeof window.adrMgr!=="undefined"&&window.adrMgr.selectedCity!=="undefined"&&typeof window.docContext!=="undefined"){this.city=window.adrMgr.other||window.adrMgr.selectedCity;app.addr=new AddressInfo();app.addr.connect_form(this.city,this.showWithDate);app.addr.doTechCheck=function(){return $("#all_services input:checked[name=homeinet]").length||$("#all_services input:checked[name=iptv]").length};app.addr.bindAddressHint({mode:"callback"})}if(this.isExtMode()){this.loadData()}$(".js-city").click(function(e){e.preventDefault();e.stopPropagation();if($(this).closest("#callback-suggest").size()>0){$.magnificPopup.close()}$("html, body, .p-sideslide__inner").animate({scrollTop:0},400);$(".location-label:not(.location-label_state-on)").trigger("click")});if(this.shortForm){this.statGoal="main_fast_order"}stat.sendCustomStat(this.statGoal)};this.loadData=function(){if(!this.isExtMode()){return}var _this=this;if(this.shortForm){$("#order_form").find(".connect_address").html('Проверьте адрес подключения&nbsp;<span class="btn-txt dashed-link color-blue js-city"></span>');var tipsyClass="tipsy-s";var mq_flag=1;if(!!mq()){mq_flag=mq()}if($.inArray(mq_flag,[3,4])>-1){tipsyClass="tipsy-se"}$("#order_form").find(".js-city").before('<span class="dashed-link color-blue js-'+tipsyClass+" "+tipsyClass+'" style="cursor: pointer" original-title data-tooltip="Здесь вы можете ввести свой адрес и проверить, есть ли у нас технические возможности оказать Вам данную услугу">(?)</span> ')}actions.tipsyInit();app.wi.bindTipsyUpdater($("#order_form").find(".js-city").prev(),"s","se");$(".js-city").text(adrMgr.other?adrMgr.other.name:adrMgr.selectedCity.name);$("#order_tariff_service,#order_tariff").hide();var proxyUrl="/pages/proxy.jsp?proxyType=agent&proxyMethod=GET&urlCode=crate_order_tariffs&region="+adrMgr.selectedCity.klRegion;if(adrMgr.other){proxyUrl+="&local_id="+adrMgr.other.mpzCode}else{proxyUrl+="&local_id="+adrMgr.selectedCity.mpzCode}$.ajax({url:proxyUrl,dataType:"json",success:function(data){glb_data=data;if(utils.isObject(data)&&data.isError>0){app.tariffs={}}else{app.tariffs=utils.isEmpty(data)?{}:data}_this.binds();_this.renderServices()}}).fail(function(){glb_data={};app.tariffs={};_this.binds();_this.renderServices()})};this.compare_packets=function(arr,arr2){if(arr.length!==arr2.length){return false}var on=0;for(var i=0;i<arr.length;i++){for(var j=0;j<arr2.length;j++){if(arr[i]===arr2[j]){on++;break}}}return on===arr.length};this.binds=function(){var _this=this;$(".js-goto-with-save-state").click(function(){var $tariff=$("#tariff").find("option:selected"),services=[];$("#all_services").find("input:checked").each(function(){services.push($(this).attr("name"))});$.cookie(_this.stateCookie,$.param({source:document.location.href,target:$(this).attr("href").replace(/\?.*/,""),services:services,packet:$tariff.attr("packet"),packetId:$tariff.attr("packet_id"),address:app.addr.address_process(),callTime:$("#order_time_call").val(),dateConnect:$("#order_date_connect").val(),timeConnect:$("#order_time_connect").val(),comment:$("#order_comment").val(),lastName:$("#order_last_name").val(),firstName:$("#order_first_name").val(),phone:$("#order_phone").val(),email:$("#order_email").val(),phoneState:$("#order_phone_state").find("input").is(":checked"),emailState:$("#order_email_state").find("input").is(":checked")}),{path:"/",domain:"."+domain})});$("input[name=iptv] , input[name=homeinet], input[name=phone]").on("ifChanged update-tariffs",function(){$($("#order_tariff").find("a")[1]).parent().hide();$("#order_tariff_service,#order_tariff").hide();var t=[],v=[],i=0;var srvs={shpd:false,iptv:false,pstn:false};$("input[name=iptv]:checked , input[name=homeinet]:checked, input[name=phone]:checked").each(function(){var name=$(this).attr("name");name=$(this).attr("name")==="homeinet"?"shpd":name;name=$(this).attr("name")==="phone"?"pstn":name;t[t.length]=name;srvs[name]=true});$("#hometel_det").parent().hide();$("#tariff_label").text("Тариф");var _href=(utils.isEmpty(adrMgr.selectedCity.synonym)?"":"/"+adrMgr.selectedCity.synonym)+"/hometel/local";if(srvs.shpd&&srvs.pstn&&!srvs.iptv){t=[];t.push("shpd");$("#hometel_det").attr("href",_href).parent().show();$("#tariff_label").text("Тариф на Домашний интернет")}if(srvs.iptv&&srvs.pstn&&!srvs.shpd){t=[];t.push("iptv");$("#hometel_det").attr("href",_href).parent().show();$("#tariff_label").text("Тариф на Интерактивное ТВ")}if(srvs.shpd&&srvs.iptv){$("#tariff_label").text("Тариф")}if(srvs.pstn&&!srvs.shpd&&!srvs.iptv){$("#hometel_det").attr("href",_href).parent().show()}var tariffDetailHref="/packages/tariffs";if(t.length===1){var links={shpd:"/homeinternet/order_internet",iptv:"/hometv/tariff",pstn:"/hometel/local"};if(links[t[0]]){tariffDetailHref=links[t[0]]}}$html='<option value="-1" selected="" disabled="">Выберите</option>';var showTariffs=[];function selTar(){$.each(app.tariffs,function(section,tag){v=[];$.each(tag.tariffs,function(s){v[v.length]=s});if(_this.compare_packets(t,v)){$.each(tag.packets,function(packet_id,val){val.section=section;val.packet_id=packet_id;showTariffs.push(val)})}})}selTar();if(showTariffs.length==0&&t.length==3){$("#tariff_label").text("Тариф на Домашний интернет и Интерактивное ТВ");t.pop("pstn");selTar();$("#hometel_det").attr("href",_href).parent().show()}showTariffs=_.sortBy(showTariffs,function(t){return t.fee});if(_this.shortForm){if(showTariffs.length>0){var val=showTariffs[0];var shpd;var iptv;if(val.shpd&&app.tariffs[val.section].tariffs.shpd){shpd=app.tariffs[val.section].tariffs.shpd[val.shpd[0]]}if(val.iptv&&app.tariffs[val.section].tariffs.iptv){iptv=app.tariffs[val.section].tariffs.iptv[val.iptv[0]]}if(val.iptv&&val.tariffOverload&&val.tariffOverload[val.iptv[0]]){iptv=val.tariffOverload[val.iptv[0]]}$html='<div class="section-block-divider"><a class="more-link more-link_right-head more-link_no-mgr" href="#">Посмотреть все тарифы</a>';if(shpd){var shpdTitle=shpd.title.split('"').join("'");$html+='<p class="label-type2">Тариф «'+shpdTitle+"»</p>";var speed=shpd.speed;if(speed<1024){speed=speed+" Кбит/с"}else{speed=speed/1024;speed=(speed%1>=0.05)?speed.toFixed(1):speed.toFixed(0);speed=speed+" Мбит/с"}$html+='<p class="content-p-4 content-p-0_last">Домашний Интернет - '+speed.replace(".",",")+"</p>"}if(iptv&&!shpd){$html+='<p class="label-type2">Тариф Интерактивного ТВ</p><br>'}$html+='<p class="content-p-4 content-p-0_last units-row">';if(val.isAction&val.isAction==true){$html+='<span class="float-right" style="margin-top: -.6em">от ';$html+="<span class='cost-strike cost-strike_stand-inrow cost-strike_insel'>"+(val.feeAfter/100)+"</span>";$html+='<b class="f-24">'}else{$html+='<span class="inline-block float-right">от ';$html+="<b>"}$html+=(val.fee/100)+"</b> руб./мес.</span>";if(iptv){var iptvTitle=iptv.title.split('"').join("'");$html+=iptvTitle+" ("+iptv.pkgCount+" "+_this.declOfNum(iptv.pkgCount,["канал","канала","каналов"])+")</span>"}$html+="</p></div>";$("#order_tariff span").html($html);_this.selTar=val;$("#tariff").trigger("change")}}else{$.each(showTariffs,function(packet_id,val){var shpd;var iptv;if(val.shpd&&app.tariffs[val.section].tariffs.shpd){shpd=app.tariffs[val.section].tariffs.shpd[val.shpd[0]]}if(val.iptv&&app.tariffs[val.section].tariffs.iptv){iptv=app.tariffs[val.section].tariffs.iptv[val.iptv[0]]}if(val.iptv&&val.tariffOverload&&val.tariffOverload[val.iptv[0]]){iptv=val.tariffOverload[val.iptv[0]]}i++;$html+='<option value="'+packet_id+'" packet='+val.section+" packet_id="+val.packet_id+' data-opt="';$html+="<span class='sel-opt-desc'>";if(shpd){var shpdTitle=shpd.title.split('"').join("'");$html+="<span class='sel-opt-str'>"+shpdTitle+" <b>"+(shpd.speed/1024)+"</b> Мбит/с</span>"}if(iptv){var iptvTitle=iptv.title.split('"').join("'");$html+="<span class='sel-opt-str'>"+iptvTitle+" <b>("+iptv.pkgCount+" каналов)</b></span>"}var pkgTitle=val.title.split('"').join("'");$html+="</span>";$html+="<span class='sel-opt-cost'>от ";if(val.isAction&val.isAction==true){$html+="<span class='cost-strike cost-strike_insel cost-strike_stand-inrow bold'>"+(val.feeAfter/100)+"</span>"}$html+="<b>"+(val.fee/100)+"</b> руб./мес.</span>";$html+='">'+pkgTitle+"</option>"});$("#order_tariff select").html($html);$("#order_tariff select.js-selectric3").removeClass("opt-replased").selectric("refresh")}if(showTariffs.length>0){$("#order_tariff").show()}var synonym="";if(!!adrMgr.other){synonym="/other"}else{if(adrMgr.selectedCity.synonym!=adrMgr.selectedRegion.synonym){synonym=(utils.isEmpty(adrMgr.selectedCity.synonym)?"":"/"+adrMgr.selectedCity.synonym)}}$($("#order_tariff a")[0]).attr("href",synonym+tariffDetailHref)});$("#order_tariff select").on("change",function(e){var hrefs={"332":"/packages/tariffs/correct_price_3","331":"/packages/tariffs/correct_price_2","330":"/packages/tariffs/correct_price_1_pon","329":"/packages/tariffs/correct_price_1","312":"/packages/tariffs/triple","289":"/packages/tariffs/triple","287":"/packages/tariffs/strong","313":"/packages/tariffs/strong","317":"/packages/tariffs/your_active","286":"/homeinternet/order_internet/strong","282":"/packages/tariffs/double_package","224":"/packages/tariffs/tvin","297":"/packages/tariffs/tvin","223":"/packages/tariffs/tvin_fast","298":"/packages/tariffs/tvin_fast","218":"/homeinternet/order_internet/homeinternet_fast","219":"/homeinternet/order_internet/home","110":"/hometv/tariff","290":"/hometv/tariff","361":"/hometv/tariff","362":"/homeinternet/order_internet","363":"/packages/tariffs/packet_summer","337":"/homeinternet/order_internet","342":"/packages/tariffs/packet_double"};var link=$(e.target).find("option:selected");var packet=link.attr("packet"),packet_id=link.attr("packet_id");var synonym=(utils.isEmpty(adrMgr.selectedCity.synonym)?"":"/"+adrMgr.selectedCity.synonym);var href=synonym+hrefs[packet];try{if((packet==312||packet==289)&&app.tariffs[packet].packets[packet_id].title.indexOf("Оптимальный")>=0){href+="_optimal"}}catch(error){}if(href&&app.tariffs[packet].packets[packet_id].shpd&&app.tariffs[packet].packets[packet_id].shpd.length>0){if(app.tariffs[packet].packets[packet_id].pkgId){href+="?id="+app.tariffs[packet].packets[packet_id].pkgId}else{href+="?id="+app.tariffs[packet].packets[packet_id].shpd[0]}}if(href){$($("#order_tariff a")[1]).parent().show();$($("#order_tariff a")[1]).attr("href",href)}else{$($("#order_tariff a")[1]).parent().hide()}return false})};this.render=function(){initDatePick($(".js-input-datepick"));$("#order_connect").hide();$(".js-showbox-switch").on("click",function(e){e.preventDefault();var boxid=$(this).attr("href"),thisid=this.id;if(boxid===undefined){boxid=$(this).attr("data-href")}var attrid=$(boxid).attr("data-swithbox");if(attrid===undefined){attrid="#"+thisid;$(boxid).attr("data-swithbox",attrid)}else{attrid=$(boxid).attr("data-swithbox")}$(boxid).addClass("is-switch");$(attrid).removeClass("is-switch");$(boxid).on("click",function(e){e.preventDefault();if($(this).hasClass("is-switch")){$(this).removeClass("is-switch");$(attrid).addClass("is-switch")}})});var _this=this;var $chbx=$("#all_services").find("input");$chbx.each(function(){$(this).on("ifChanged",function(){if($("#all_services input:checked").length!=0){$("#noneServiceSelectWarn").addClass("none-elem");$("#all_services>div>div").removeClass("index-ad-block_error")}})});var $street=$("#order_street");var $house=$("#order_house");var $flat=$("#order_flat");var $city=$("#order_city");$street.addClass("filter-address").addClass("validator-filtered");$street.attr("required","true").attr("data-invalid-error","Неверно указана улица");$house.addClass("filter-house validator-filtered");$house.attr("required","true").attr("data-invalid-error","Неверно указан номер дома");$flat.addClass("filter-house validator-filtered");$flat.attr("required","true").attr("data-invalid-error","Неверно указана квартира");$(".additional").html("(обязательно)");window.construct.reloadByName(["configChoise"],true);$(window).trigger("affect-filters");$city.val(this.city.name);$city.attr("disabled","disabled");$("#order_phone,#order_email").bind("input",function(){var _this=$(this);var mass_check=["#order_phone_state","#order_email_state"];for(var el in mass_check){if(mass_check[el].indexOf(_this.attr("id"))>-1){if(_this.val().length>0){$(mass_check[el]).removeClass("callback-form__label-inline_disabled-true");$(mass_check[el]+" input").removeAttr("disabled")}else{$(mass_check[el]).addClass("callback-form__label-inline_disabled-true");$(mass_check[el]+" input").attr("disabled","disabled")}}}});$("#save_btn").on("click",function(){_this.orderAPI.clear();if($("#all_services input:checked").length==0){$("#noneServiceSelectWarn").removeClass("none-elem");$("#all_services>div>div").addClass("index-ad-block_error");return}else{$("#noneServiceSelectWarn").addClass("none-elem");$("#all_services>div>div").removeClass("index-ad-block_error")}if(_this.isNeedInAddress()||$("#order_connect").is(":visible")&&$("#order_date_connect").val()!=""){_this.prepareOrder(this.id)}else{_this.prepareCallback(this.id)}});$("#order_email").on("change",function(){if($(this).val().length>0){$("#order_sendEmail").removeClass("callback-form__label-inline_disabled-true");$("#order_sendEmail input").removeAttr("disabled")}else{if(!$("#order_sendEmail").hasClass("callback-form__label-inline_disabled-true")&&!$("#order_sendEmail input").prop("disabled")){$("#order_sendEmail").addClass("callback-form__label-inline_disabled-true");$("#order_sendEmail input").prop("disabled","disabled")}}});if(!this.isExtMode()){this.renderServices()}if(this.previousState){$("#order_comment").val(this.previousState.comment);$.each({"#order_last_name":_this.previousState.lastName,"#order_first_name":_this.previousState.firstName,"#order_phone":_this.previousState.phone,"#order_email":_this.previousState.email},function(selector,value){var $input=$(selector);if(!utils.isEmpty(value)){$input.val(value);$input.trigger("input").validatorFilter("validate").data("second",true)}});$("#order_phone_state").find("input").prop("checked",utils.toBoolean(this.previousState.phoneState));$("#order_email_state").find("input").prop("checked",utils.toBoolean(this.previousState.emailState));$("#order_time_call").val(this.previousState.callTime).selectric("refresh");var previousAddress=this.previousState.address,currentAddress=app.addr.address_process();if(currentAddress.region==previousAddress.region&&currentAddress.city==previousAddress.city&&currentAddress.cityId==previousAddress.cityId){var isFullAddress=true;$.each({"#order_street":previousAddress.street,"#order_house":previousAddress.house,"#order_flat":previousAddress.flat},function(selector,value){var $input=$(selector);if(!utils.isEmpty(value)){$input.val(value)}else{isFullAddress=false}});if(isFullAddress){app.addr.setSuggestablePartOfAddress(previousAddress);var previousDate=this.previousState.dateConnect,previousTime=this.previousState.timeConnect;$("#order_connect").one("onshow",function(){if(app.addr.rules_try_count==1){var $time=$("#order_time_connect");if(previousDate){var prevDateObj=$.datepick.parseDate("dd M yyyy",previousDate),nowDateObj=new Date();prevDateObj.setHours($time.find('option[value="'+previousTime+'"]').data("hour")||0);if(prevDateObj.getTime()-nowDateObj.getTime()>=24*60*60*1000){_this.onDateChange(prevDateObj);$("#order_date_connect").val(previousDate);$time.val(previousTime).selectric("refresh").trigger("change")}}}});app.addr.setFlat(this.showWithDate);$("#order_flat").trigger("input")}}}};this.renderServices=function(){var isUpdated=false;if(this.previousState&&this.previousState.services){$("#all_services").find("input").each(function(){var $input=$(this);if($.inArray($input.attr("name"),_this.previousState.services)!=-1){if(!$input.is(":checked")){$input.iCheck("check")}}})}else{if(this.initSrvFilter){var $iCheck=$();if(this.initSrvFilter==="all"){$iCheck=$(".config-choise-mini__label")}else{$iCheck=$(".config-choise-mini__label"+this.initSrvFilter)}$iCheck.find("input").each(function(){var $input=$(this);if(!$input.is(":checked")){$input.iCheck("check")}});isUpdated=true}}var $services=$("#all_services").find("input:checked");if(!isUpdated){$services.trigger("update-tariffs")}if($services.size()>0){if(this.previousState&&!utils.isEmpty(this.previousState.packet)&&!utils.isEmpty(this.previousState.packetId)){var $tariffs=$("#tariff"),$tariff=$tariffs.find("option").filter(function(){var $option=$(this);return $option.attr("packet")==_this.previousState.packet&&$option.attr("packet_id")==_this.previousState.packetId});if($tariff.size()>0){$tariffs.val($tariff.val()).change().selectric("refresh")}}}};var $giftSection=$("#gifts-web-options"),$giftOptions=$giftSection.find(".js-gift"),giftIdMap={};$giftOptions.each(function(){var $gift=$(this);giftIdMap[$gift.data("str-id")]=$gift.data("base-str-id")});function getOption(options,id){if(!options){return null}var $options=$(options).filter(function(i,option){return option.id==id||option.name==id||option.altName==id});if($options.size()==0){for(var i in options){var option=getOption(options[i].options,id);if(option){return option}}}else{return $options[0]}return null}function getSelectedTariffIds(){var tag=getSelectedTag();var packet_id;if(_this.shortForm){packet_id=_this.selTar?_this.selTar.packet_id:null}else{packet_id=$("#tariff").find("option:selected").attr("packet_id")}if(utils.isEmpty(tag)||utils.isEmpty(packet_id)){return[]}var packet=app.tariffs[tag]["packets"][packet_id];var selectedTypes=getSelectedTypes();return $.map(["iptv","shpd","pstn"],function(type){return selectedTypes.indexOf(type)!=-1&&packet[type]&&packet[type].length>0?packet[type][0]:null})}function getSelectedTag(){if(_this.shortForm){return _this.selTar?_this.selTar.section:null}else{return $("#tariff").find("option:selected").attr("packet")}}function getSelectedServices(){return $.map($("#all_services").find("input:checked"),function(input){return $(input).attr("name")})}function getSelectedTypes(){return $.map(getSelectedServices(),function(service){switch(service){case"homeinet":return"shpd";case"iptv":return"iptv";case"phone":return"pstn";default:return null}})}this.loadedGiftOptions={};this.loadGiftsWebAction=function(tag,callback){if(_this.loadedGiftOptions[tag]){callback(_this.loadedGiftOptions[tag])}else{var address=adrMgr.other?adrMgr.other:adrMgr.selectedCity;var proxyUrl="/pages/proxy.jsp?proxyType=agent&proxyMethod=GET&urlCode=tag_tariffs&tag="+tag+"&addr_code="+address.klCode+"&region="+address.klRegion+"&addr_level="+address.klLvl;$.ajax({url:proxyUrl,dataType:"json",success:function(data){if(utils.isEmpty(data)||_this.loadedGiftOptions[tag]){return}var tariffGiftsMap={};for(var ti in data){var tariff=data[ti];var gifts={};$([tariff.options,tariff.choices,(tariff.packages||{}).packages,(tariff.subsPack||{}).subscriptions]).each(function(oi,options){for(var giftId in giftIdMap){var gift=getOption(options,giftId);if(gift){if(utils.toInt(gift.afterFee)==0){gift.afterFee=(getOption(options,giftIdMap[giftId])||{}).fee||0}gifts[giftId]=gift}}});tariffGiftsMap[tariff.id]=gifts}_this.loadedGiftOptions[tag]=tariffGiftsMap;callback(tariffGiftsMap)}})}};this.bindGiftsWebAction=function(){actions.iCheckCheckboxBlue();actions.iCheckRadioBlue();function resetGifts(){$giftSection.hide();$giftOptions.find("input").iCheck("uncheck");$giftOptions.find(".js-title").removeClass("bold");$giftOptions.find(".js-after-fee").text("").hide()}function updateGifts(){resetGifts();var tag=getSelectedTag();var tariffIds=getSelectedTariffIds();if(!utils.isset(tag)||utils.isEmpty(tariffIds)){return}_this.loadGiftsWebAction(tag,function(tariffIdGiftsMap){var currentTariffIds=getSelectedTariffIds();if(utils.containsAll(tariffIds,currentTariffIds)&&utils.containsAll(currentTariffIds,tariffIds)){var gifts={};for(var tariffId in tariffIdGiftsMap){if(tariffIds.indexOf(utils.toInt(tariffId))!=-1){gifts=$.extend(gifts,tariffIdGiftsMap[tariffId])}}$giftOptions.each(function(){var $gift=$(this);var gift=gifts[$gift.data("str-id")];$gift.find(".js-title").toggleClass("bold",utils.isset(gift));if(gift&&gift.afterFee>0){$gift.find(".js-after-fee").text(Math.round(utils.toInt(gift.afterFee)/100)).show()}else{$gift.find(".js-after-fee").text("").hide()}var $input=$gift.find("input");$gift.toggle(utils.isset(gift));if(gift&&gift.required){$input.iCheck("check")}});if(!utils.isEmpty(gifts)){var selectedServices=getSelectedServices();$giftSection.find(".js-header").hide().filter(function(){var services=$.map(($(this).data("services")||"").toString().split(","),function(service){return $.trim(service)});return utils.containsAll(selectedServices,services)}).first().show();$giftSection.show()}else{$giftSection.hide()}}})}var lastTariffIds=getSelectedTariffIds();$("#all_services").find("input").on("ifChanged",function(){var currentTariffIds=getSelectedTariffIds();if(!(utils.containsAll(lastTariffIds,currentTariffIds)&&utils.containsAll(currentTariffIds,lastTariffIds))){resetGifts()}lastTariffIds=currentTariffIds});$("#tariff").bind("change single-select",function(){updateGifts()});var $iptvGiftChecks=$giftOptions.find('input[name="iptv-gift"]');$iptvGiftChecks.on("ifChanged",function(){var $this=$(this);if($this.is(":checked")){$iptvGiftChecks.not($this).filter(":checked").iCheck("uncheck")}});resetGifts()};this.prepareCallback=function(id){if(!utils.buttonLoader(id)){return false}var services=$("#all_services input:checked").size()>0?$("#all_services input:checked"):$("#order_service");this.orderAPI.createCallBack();this.orderAPI.orderData.region=this.city.klRegion;this.orderAPI.orderData.cellPhone=$("#order_phone").val();this.orderAPI.orderData.email=$("#order_email").val();this.orderAPI.setFio($("#order_name").val());this.orderAPI.orderData.notifyBySMS=($("#order_phone_state input").is(":checked"))?1:0;this.orderAPI.orderData.notifyByEmail=($("#order_email_state input").is(":checked"))?1:0;if($("#order_comment").size()>0&&$("#order_comment").length>0){this.orderAPI.orderData.dopInfo=$("#order_comment").val()}if($("#order_service").size()===0){if($("#order_time_call option:selected").val()==-1){var hour=utils.getNowHour();if(hour<9||hour>=19){this.orderAPI.orderData.callTimeFrom=9;this.orderAPI.orderData.callTimeTill=10}else{this.orderAPI.orderData.callTimeFrom=hour+1;this.orderAPI.orderData.callTimeTill=hour+2}}else{this.orderAPI.orderData.callTimeFrom=$("#order_time_call option:selected").val();this.orderAPI.orderData.callTimeTill=$("#order_time_call option:selected").data("hour")}}if(app.addr){this.orderAPI.setAddress()}else{this.orderAPI.setAddress({city:this.city.name,cityId:this.city.mpzCode,street:$("#order_street").val(),house:$("#order_house").val(),flat:$("#order_flat").val()})}if(services.length>0){for(var index=0;index<services.length;index++){var tab=this.orderAPI.addTab(this.svcClass(services[index].name));tab.productState=17}this.createOrder()}};Date.prototype.getFormatDate=function(){var day=(this.getDate()+1)>9?(""+(this.getDate()+1)):("0"+(this.getDate()+1));var month=(this.getMonth()+1)>9?(""+(this.getMonth()+1)):("0"+(this.getMonth()+1));var year=this.getFullYear();return day+"."+month+"."+year};this.prepareOrder=function(id){var btnElm=$("#"+id);if(!utils.buttonLoader(id)){return false}this.orderAPI.createOrder();if($("#order_tariff").is(":visible")&&$("#order_tariff select > option:selected").val()==="-1"){utils.Notice("Выберите тариф");utils.buttonUnLoader(id,"Оставить заявку");return false}if($("#order_tariff_service").is(":visible")&&$("#order_tariff_service select > option:selected").val()==="-1"){utils.Notice("Выберите копмлект");utils.buttonUnLoader(id,"Оставить заявку");return false}var services=$("#all_services input:checked").size()>0?$("#all_services input:checked"):$("#order_service");this.orderAPI.setAddress();this.orderAPI.setNames($.trim($("#order_first_name").val()),$.trim($("#order_last_name").val()));if(this.shortForm){this.orderAPI.setFio($("#order_last_name").val())}this.orderAPI.orderData.cellPhone=$("#order_phone").val();this.orderAPI.orderData.email=$("#order_email").val();this.orderAPI.orderData.notifyBySMS=($("#order_phone_state input").is(":checked"))?1:0;this.orderAPI.orderData.notifyByEmail=($("#order_email_state input").is(":checked"))?1:0;if($("#order_comment").size()>0&&$("#order_comment").length>0){this.orderAPI.orderData.dopInfo=$("#order_comment").val()}else{if(!this.shortForm){var tarif=$(".unit-tariff.unit-tariff_selected-true").find(".unit-tariff__name_top").text();var cost=$(".unit-tariff.unit-tariff_selected-true").find(".cost-rubmonth").text();var inter=$("#tariff_inter_commun option:selected").text();var intra=$("#tariff_intrazonal option:selected").text();this.orderAPI.orderData.dopInfo="Тариф на местную связь:\n"+tarif+" "+cost+" руб./мес.\nТариф междугородной и международной связи:\n"+inter+"\nТариф внутризоновой связи:\n"+intra}}if(!this.isExtMode()){this.orderAPI.orderData.params.is_quick_request=2}else{this.orderAPI.orderData.params.is_quick_request=1}if($("#order_service").size()===0){if($("#order_time_call option:selected").val()==-1){var hour=utils.getNowHour();if(hour<9||hour>=19){this.orderAPI.orderData.callTimeFrom=9;this.orderAPI.orderData.callTimeTill=10}else{this.orderAPI.orderData.callTimeFrom=hour+1;this.orderAPI.orderData.callTimeTill=hour+2}}else{this.orderAPI.orderData.callTimeFrom=$("#order_time_call option:selected").val();this.orderAPI.orderData.callTimeTill=$("#order_time_call option:selected").data("hour")}}if(services.length>0){for(var index=0;index<services.length;index++){var svcClassId=this.svcClass(services[index].name);var gifts=$.map($giftOptions.filter(function(){var $gift=$(this);return $gift.find("input:checked").length>0&&$gift.data("svc-class-id")==svcClassId}),function(gift){return $(gift).data("str-id")});var tab=this.orderAPI.addTab(svcClassId,0);this.formService(services[index].name,tab);tab.options=(tab.options||[]).concat(gifts)}this.createOrder()}};this.createOrder=function(){var thus=this;var attrs={};if(this.isNeedInAddress()){attrs.techCapIds=app.addr.getTechCapIds()}if(thus.formName){this.orderAPI.formName=thus.formName}stat.sendCustomStat(thus.statGoal,"_click");var sendCallback=function(data){data=data||{};if(data.isError!==undefined&&data.isError===0){if(thus.isExtMode()){stat.fixStat(thus.statGoal)}else{stat.fixStat("gduzvonka")}stat.sendCustomStat(thus.statGoal,"_done");configurators.openSuccessPopup(_this.orderAPI,data);clearForm()}else{configurators.showErrorPopup(data)}};if(!app.addr.addressIsSelected()){utils.buttonUnLoader("save_btn","Оставить заявку");configurators.callbackSuggest($("#callback-suggest"),this.orderAPI,sendCallback,attrs)}else{this.orderAPI.send(function(data){sendCallback(data);utils.buttonUnLoader("save_btn","Оставить заявку")},attrs,true)}};Date.prototype.addHours=function(h){this.setHours(this.getHours()+h);return this};this.onDateChange=function(selectedDate){var now=new Date();var $times=$("#order_time_connect option");var isFirst=true;$times.each(function(){var sHour=$(this).data("hour");var _$thisTime=$(this);var date=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),selectedDate.getDate()).addHours(sHour);if(date.getTime()-now.getTime()<24*60*60*1000){_$thisTime.prop("disabled","disabled")}else{_$thisTime.prop("disabled",false);if(isFirst){isFirst=false;_$thisTime.prop("selected",true)}}});$("#order_time_connect").selectric("refresh")};var _this=this;var last_rules_try_count=0;this.showWithDate=function(){if(last_rules_try_count==app.addr.rules_try_count){return}last_rules_try_count=app.addr.rules_try_count;var $order=$("#order_connect").show();var $select=$("#order_street,#order_house,#order_flat");$select.keypress(function(){$(".tipsy.tipsy-t").remove();$(window).trigger("affect-filters");$("#order_connect").hide();$("#order_date_connect").val("");$("#order_time_connect").val(9).selectric("refresh");$("#message_process").hide();$select.unbind("keypress")});$order.trigger("onshow");var cache=$("#order_date_connect").val();setInterval(function(){if($("#order_date_connect").val()!==cache&&$("#order_date_connect").val().length>0){cache=$("#order_date_connect").val();_this.onDateChange($.datepick.parseDate("dd M yyyy",cache))}},100)};var clearForm=function(){$("#order_form input").filter('[type="text"]').not(".selectric0-input").not("#order_city").each(function(){$(this).val("").trigger("change.placeholder")});$("#order_form textarea").val("");$("#order_comment").val("");$("#order_phone_state,#order_email_state").addClass("callback-form__label-inline_disabled-true");$("#order_phone_state input,#order_email_state input").prop("checked",true).prop("disabled","disabled");$("#order_time_call option:first").prop("selected","selected");$(".js-selectric0").selectric("refresh");$(".address_block_tech").hide();$("#message_process").hide();utils.buttonUnLoader("save_btn");$(window).trigger("affect-filters")};this.formAddress=function(){if(!app.addr){return}return app.addr.address_process()};this.svcClass=function(synonym){if(synonym==="homeinet"){return 1}if(synonym==="iptv"){return 2}if(synonym==="phone"){return 3}throw new Error("Не возможно определить тип услуги")};this.formService=function(synonym,tab){var service={},$tariff=$("#order_tariff select > option:selected"),$usluga=$("#order_tariff_service select > option:selected");var pkgTag=$tariff.attr("packet");var pkgChoiseIds=$tariff.attr("packet_id");var pkg;var pkgTariffs;if(pkgTag&&pkgChoiseIds){pkg=app.tariffs[$tariff.attr("packet")]["packets"][$tariff.attr("packet_id")];pkgTariffs=app.tariffs[$tariff.attr("packet")]["tariffs"]}if(_this.shortForm){try{pkg=_this.selTar;pkgTariffs=app.tariffs[_this.selTar.section]["tariffs"]}catch(error){}}tab.productState=1;if(synonym==="iptv"){tab.tarPlan=170633;if($("#order_tariff").is(":visible")&&pkg.iptv){tab.tarPlan=pkg.iptv[0];if(pkg.tariffOverload&&pkg.tariffOverload[pkg.iptv[0]]&&pkg.tariffOverload[pkg.iptv[0]].requiredОptions){tab.options=pkg.tariffOverload[pkg.iptv[0]].requiredОptions}else{if(pkgTariffs&&pkgTariffs.iptv&&pkgTariffs.iptv[pkg.iptv[0]]&&pkgTariffs.iptv[pkg.iptv[0]].requiredОptions){tab.options=pkgTariffs.iptv[pkg.iptv[0]].requiredОptions}}}}if(synonym==="homeinet"){tab.domominimum=null;tab.tarPlan=170634;if($("#order_tariff").is(":visible")&&pkg.shpd){tab.tarPlan=pkg.shpd[0];if(pkg.tariffOverload&&pkg.tariffOverload[pkg.shpd[0]]&&pkg.tariffOverload[pkg.shpd[0]].requiredОptions){tab.options=pkg.tariffOverload[pkg.shpd[0]].requiredОptions}else{if(pkgTariffs&&pkgTariffs.shpd&&pkgTariffs.shpd[pkg.shpd[0]]&&pkgTariffs.shpd[pkg.shpd[0]].requiredОptions){tab.options=pkgTariffs.shpd[pkg.shpd[0]].requiredОptions}}}}if(synonym==="phone"){tab.tarPlan=170635;if($("#order_tariff").is(":visible")&&pkg.pstn){tab.tarPlan=pkg.pstn[0];if(pkg.tariffOverload&&pkg.tariffOverload[pkg.pstn[0]]&&pkg.tariffOverload[pkg.pstn[0]].requiredОptions){tab.options=pkg.tariffOverload[pkg.pstn[0]].requiredОptions}else{if(pkgTariffs&&pkgTariffs.pstn&&pkgTariffs.pstn[pkg.pstn[0]]&&pkgTariffs.pstn[pkg.pstn[0]].requiredОptions){tab.options=pkgTariffs.pstn[pkg.pstn[0]].requiredОptions}}}}if($("#order_connect:visible").size()>0){tab.wishTime=$("#order_time_connect").val();if($("#order_date_connect").val()!==""){var mass_date=$("#order_date_connect").val().split(" ");var month={"01":"Января","02":"Февраля","03":"Марта","04":"Апреля","05":"Мая","06":"Июня","07":"Июля","08":"Августа","09":"Сентября","10":"Октября","11":"Ноября","12":"Декабря"};tab.wishDate=mass_date[0]+".";for(var mm in month){if(mass_date[1]===month[mm]){tab.wishDate+=mm+"."}}tab.wishDate+=mass_date[2]}else{tab.wishDate=""}}else{tab.wishTime="";tab.wishDate=""}return tab};this.declOfNum=function(number,titles){cases=[2,0,1,1,1,2];return titles[(number%100>4&&number%100<20)?2:cases[(number%10<5)?number%10:5]]}}})();